<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FundFlow - æ™ºèƒ½åŸºé‡‘ç›‘æ§ç³»ç»Ÿ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #3b82f6; --primary-dark: #2563eb; --primary-light: #60a5fa; --primary-ultra-light: #dbeafe; --success: #ef4444; --danger: #10b981; --warning: #f59e0b; --purple: #8b5cf6; --purple-dark: #7c3aed; --gray-50: #fafafa; --gray-100: #f5f5f5; --gray-200: #e5e5e5; --gray-300: #d4d4d4; --gray-400: #a3a3a3; --gray-500: #737373; --gray-600: #525252; --gray-700: #404040; --gray-800: #262626; --gray-900: #171717; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #f0fdf4 100%); color: var(--gray-900); overflow-x: hidden; }
        .app-container { display: flex; height: 100vh; position: relative; }
        
        /* ç§»åŠ¨ç«¯èœå•æŒ‰é’® */
        .mobile-menu-btn { display: none; position: fixed; top: 20px; left: 20px; z-index: 1001; width: 48px; height: 48px; background: white; border: 2px solid var(--gray-200); border-radius: 12px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.1); flex-direction: column; align-items: center; justify-content: center; gap: 4px; }
        .mobile-menu-btn span { width: 24px; height: 3px; background: var(--gray-700); border-radius: 2px; transition: all 0.3s; }
        .mobile-menu-btn.active span:nth-child(1) { transform: rotate(45deg) translate(6px, 6px); }
        .mobile-menu-btn.active span:nth-child(2) { opacity: 0; }
        .mobile-menu-btn.active span:nth-child(3) { transform: rotate(-45deg) translate(6px, -6px); }
        
        .sidebar { width: 420px; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(20px); border-right: 1px solid rgba(229, 229, 229, 0.6); display: flex; flex-direction: column; overflow: hidden; box-shadow: 4px 0 20px rgba(0, 0, 0, 0.03); transition: transform 0.3s; }
        .sidebar-header { padding: 20px 24px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(229, 229, 229, 0.6); }
        .logo-card { background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 50%, #ec4899 100%); border-radius: 16px; padding: 14px 20px; color: white; box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3), 0 2px 8px rgba(139, 92, 246, 0.2); position: relative; overflow: hidden; }
        .logo-card::before { content: ''; position: absolute; top: -50%; right: -30px; width: 140px; height: 200%; background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.15) 50%, rgba(255,255,255,0) 100%); transform: rotate(20deg); animation: shimmer 3s infinite; }
        @keyframes shimmer { 0% { transform: translateX(-100%) rotate(20deg); } 100% { transform: translateX(300%) rotate(20deg); } }
        .logo-content { position: relative; z-index: 1; }
        .logo-icon { width: 32px; height: 32px; background: rgba(255, 255, 255, 0.25); border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.125rem; margin-bottom: 6px; backdrop-filter: blur(10px); }
        .logo { font-size: 1.125rem; font-weight: 800; letter-spacing: -0.02em; margin-bottom: 4px; }
        .logo-subtitle { font-size: 0.75rem; opacity: 0.95; font-weight: 500; display: flex; align-items: center; gap: 8px; }
        .status-indicator { width: 7px; height: 7px; background: #10b981; border-radius: 50%; animation: pulse 2s infinite; box-shadow: 0 0 10px #10b981; }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(1.15); } }
        
        /* å¸‚åœºæŒ‡æ•° */
        .market-indices { padding: 0; background: transparent; border: none; }
        .indices-toggle { width: 100%; padding: 16px 24px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: none; border-bottom: 1px solid rgba(229, 229, 229, 0.6); cursor: pointer; display: flex; align-items: center; justify-content: space-between; transition: all 0.3s; }
        .indices-toggle:hover { background: rgba(249, 250, 251, 0.95); }
        .indices-toggle-left { display: flex; align-items: center; gap: 10px; }
        .indices-title { font-size: 0.8125rem; font-weight: 700; color: var(--gray-700); text-transform: uppercase; letter-spacing: 0.08em; display: flex; align-items: center; gap: 8px; margin: 0; }
        .indices-arrow { font-size: 0.875rem; color: var(--gray-500); transition: transform 0.3s; }
        .indices-arrow.open { transform: rotate(180deg); }
        .indices-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(229, 229, 229, 0.6); }
        .indices-content.open { max-height: 2000px; }
        .indices-inner { padding: 16px 20px; }
        
        /* ä¿®å¤ï¼šå¼ºåˆ¶3åˆ—å¸ƒå±€ */
        .indices-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; } 
        
        .index-card { background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(249,250,251,0.9) 100%); border: 1.5px solid var(--gray-200); border-radius: 12px; padding: 12px 10px; transition: all 0.3s; cursor: pointer; display: flex; flex-direction: column; justify-content: space-between; min-height: 80px; }
        .index-card:hover { border-color: var(--primary-light); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.12); }
        .index-card.positive { background: linear-gradient(135deg, rgba(254, 242, 242, 0.9) 0%, rgba(255, 255, 255, 0.9) 100%); border-color: rgba(239, 68, 68, 0.3); }
        .index-card.negative { background: linear-gradient(135deg, rgba(236, 253, 245, 0.9) 0%, rgba(255, 255, 255, 0.9) 100%); border-color: rgba(16, 185, 129, 0.3); }
        .index-card.selected { border-color: var(--primary); box-shadow: 0 4px 16px rgba(59, 130, 246, 0.2); grid-column: span 3; } /* é€‰ä¸­æ—¶å æ»¡ä¸€è¡Œ */
        
        .index-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px; }
        .index-name { font-size: 0.75rem; font-weight: 700; color: var(--gray-800); display: flex; align-items: center; gap: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
        .index-status-badge { font-size: 0.6rem; padding: 1px 4px; border-radius: 4px; background: var(--gray-100); color: var(--gray-500); font-weight: normal; margin-left: auto; display: none;}
        .index-card.closed .index-status-badge { display: inline-block; }
        .index-flag { font-size: 0.875rem; }
        
        .index-body { display: flex; flex-direction: column; align-items: flex-start; }
        .index-value { font-size: 1rem; font-weight: 800; font-family: 'JetBrains Mono', monospace; color: var(--gray-900); line-height: 1.2; margin-bottom: 2px; }
        .index-change { font-size: 0.75rem; font-weight: 700; display: flex; align-items: center; gap: 2px; }
        .index-card.positive .index-change { color: #dc2626; }
        .index-card.negative .index-change { color: #059669; }
        
        .index-chart-container { margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--gray-200); width: 100%; height: 180px; }
        .index-mini-chart { width: 100%; height: 100%; }
        .indices-refresh { margin-top: 12px; width: 100%; padding: 8px; background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: 8px; font-size: 0.75rem; color: var(--gray-600); cursor: pointer; transition: all 0.2s; font-weight: 600; }
        .indices-refresh:hover { background: var(--gray-100); border-color: var(--gray-300); }
        
        .add-fund-section { padding: 24px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(229, 229, 229, 0.6); }
        .section-title { font-size: 0.8125rem; font-weight: 700; color: var(--gray-700); margin-bottom: 16px; text-transform: uppercase; letter-spacing: 0.08em; }
        .input-row { display: grid; grid-template-columns: 1fr auto; gap: 10px; margin-bottom: 10px; }
        .input-field { width: 100%; padding: 12px 16px; border: 2px solid var(--gray-200); border-radius: 12px; font-size: 0.9375rem; font-family: 'JetBrains Mono', monospace; transition: all 0.25s; background: white; }
        .input-field:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.12); transform: translateY(-1px); }
        .btn-add { padding: 12px 24px; border: none; border-radius: 12px; font-size: 0.9375rem; font-weight: 700; cursor: pointer; transition: all 0.25s; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; white-space: nowrap; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); position: relative; overflow: hidden; }
        .btn-add:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4); }
        .optional-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .input-small { padding: 10px 14px; font-size: 0.875rem; }
        .helper-text { font-size: 0.75rem; color: var(--gray-500); margin-top: 10px; display: flex; align-items: center; gap: 6px; background: var(--gray-50); padding: 8px 12px; border-radius: 8px; border-left: 3px solid var(--primary-light); }
        .fund-suggest { margin-top: 8px; border: 1.5px solid var(--gray-200); border-radius: 12px; background: white; overflow: hidden; box-shadow: 0 8px 20px rgba(0,0,0,0.06); max-height: 260px; overflow-y: auto; display: none; }
        .fund-suggest-item { padding: 10px 12px; cursor: pointer; transition: background 0.15s; display: flex; align-items: center; justify-content: space-between; gap: 12px; }
        .fund-suggest-item:hover, .fund-suggest-item.active { background: var(--gray-50); }
        .fund-suggest-left { min-width: 0; }
        .fund-suggest-name { font-size: 0.875rem; font-weight: 700; color: var(--gray-800); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .fund-suggest-meta { font-size: 0.75rem; color: var(--gray-500); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .fund-suggest-code { font-family: 'JetBrains Mono', monospace; font-size: 0.8125rem; font-weight: 800; color: var(--gray-700); background: var(--gray-100); padding: 4px 8px; border-radius: 8px; flex-shrink: 0; }
        .fund-list { flex: 1; overflow-y: auto; padding: 16px; }
        .fund-list::-webkit-scrollbar { width: 6px; }
        .fund-list::-webkit-scrollbar-thumb { background: var(--gray-300); border-radius: 10px; }
        .fund-item { background: white; border: 2px solid transparent; border-radius: 16px; padding: 18px; margin-bottom: 14px; cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04); }
        .fund-item:hover { border-color: var(--primary-light); transform: translateX(6px) translateY(-2px); box-shadow: 0 8px 24px rgba(59, 130, 246, 0.15); }
        .fund-item.active { background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(139, 92, 246, 0.08) 100%); border-color: var(--primary); transform: translateX(8px); }
        .fund-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 14px; }
        .fund-info { flex: 1; }
        .fund-name { font-size: 0.9375rem; font-weight: 700; color: var(--gray-900); margin-bottom: 6px; }
        .fund-code { font-size: 0.75rem; color: var(--gray-500); font-family: 'JetBrains Mono', monospace; background: var(--gray-100); padding: 3px 8px; border-radius: 6px; display: inline-flex; align-items: center; gap: 8px; white-space: nowrap; }
        .fund-code-chg { font-family: 'Inter', sans-serif; font-weight: 700; font-size: 0.6875rem; padding: 1px 5px; border-radius: 4px; white-space: nowrap; }
        .fund-code-chg.positive { background: #fef2f2; color: #dc2626; }
        .fund-code-chg.negative { background: #ecfdf5; color: #059669; }
        .fund-code-chg.neutral { background: var(--gray-100); color: var(--gray-500); }
        .fund-item.card-expanded .fund-code-chg { display: none; }
        .fund-item.card-collapsed .fund-code-chg { display: inline-block; }
        .fund-actions { display: flex; gap: 6px; }
        .btn-icon { width: 32px; height: 32px; border: none; background: var(--gray-100); border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .btn-icon:hover { background: var(--gray-200); transform: scale(1.1); }
        .fund-metrics { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 12px; }
        .metric-card { background: linear-gradient(135deg, var(--gray-50) 0%, white 100%); padding: 12px; border-radius: 12px; border: 1px solid var(--gray-200); }
        .metric-label { font-size: 0.6875rem; color: var(--gray-600); margin-bottom: 4px; text-transform: uppercase; font-weight: 600; display: flex; justify-content: space-between; }
        .metric-value { font-size: 1.125rem; font-weight: 800; font-family: 'JetBrains Mono', monospace; }
        .positive { color: var(--success); }
        .negative { color: var(--danger); }
        /* åŸºé‡‘å¡ç‰‡æŠ˜å  */
        .fund-body { max-height: 200px; overflow: hidden; transition: max-height 0.35s cubic-bezier(.4,0,.2,1); }
        .fund-body.collapsed { max-height: 0; }
        .fund-header { cursor: pointer; user-select: none; }
        .fund-collapse-arrow { font-size: 0.7rem; color: var(--gray-400); transition: transform 0.3s; margin-left: 4px; display: inline-block; }
        .fund-collapse-arrow.collapsed { transform: rotate(-90deg); }
        
        /* ä¸»é¡µæ ‡é¢˜æ æŠ˜å  */
        .header-collapse-btn { background: none; border: 1.5px solid var(--gray-200); border-radius: 8px; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--gray-500); font-size: 0.875rem; transition: all 0.2s; }
        .header-collapse-btn:hover { border-color: var(--primary-light); color: var(--primary); background: var(--primary-ultra-light); }
        .stats-grid-wrapper { max-height: 520px; overflow: hidden; transition: max-height 0.35s cubic-bezier(.4,0,.2,1), margin 0.35s; padding: 6px 0; }
        .stats-grid-wrapper.collapsed { max-height: 0; margin-top: 0 !important; padding: 0; }
        .stats-grid-wrapper { margin-top: 16px; }
        
        /* æ—¥æ¶¨è·Œä¼°ç®—æ ‡è®° */
        .day-growth-source { font-size: 0.6875rem; font-weight: 600; padding: 2px 6px; border-radius: 4px; margin-left: 6px; }
        .day-growth-source.est { background: rgba(139,92,246,0.1); color: #7c3aed; }
        .day-growth-source.official { background: var(--gray-100); color: var(--gray-500); }
        
        /* æ·»åŠ åŸºé‡‘åŒºåŸŸæŠ˜å  */
        .add-fund-toggle { width: 100%; padding: 14px 24px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border: none; border-bottom: 1px solid rgba(229,229,229,0.6); cursor: pointer; display: flex; align-items: center; justify-content: space-between; transition: background 0.2s; }
        .add-fund-toggle:hover { background: rgba(249,250,251,0.98); }
        .add-fund-toggle-left { display: flex; align-items: center; gap: 10px; }
        .add-fund-toggle-title { font-size: 0.8125rem; font-weight: 700; color: var(--gray-700); text-transform: uppercase; letter-spacing: 0.08em; }
        .add-fund-arrow { font-size: 0.75rem; color: var(--gray-500); transition: transform 0.3s; }
        .add-fund-arrow.open { transform: rotate(180deg); }
        .add-fund-body { max-height: 0; overflow: hidden; transition: max-height 0.35s cubic-bezier(.4,0,.2,1); background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(229,229,229,0.6); }
        .add-fund-body.open { max-height: 300px; }
        .add-fund-inner { padding: 16px 24px 20px; }

        /* æŒä»“ç¼–è¾‘å¯¹è¯æ¡† */
        .pos-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.45); backdrop-filter: blur(4px); z-index: 20000; display: none; align-items: center; justify-content: center; }
        .pos-modal-overlay.active { display: flex; }
        .pos-modal { background: white; border-radius: 20px; width: 360px; max-width: 92vw; box-shadow: 0 24px 60px rgba(0,0,0,0.22); overflow: hidden; animation: posModalIn 0.22s cubic-bezier(.4,0,.2,1); }
        @keyframes posModalIn { from { transform: translateY(24px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .pos-modal-header { padding: 22px 24px 16px; display: flex; justify-content: space-between; align-items: center; }
        .pos-modal-title { font-size: 1.0625rem; font-weight: 800; color: var(--gray-900); }
        .pos-modal-close { width: 28px; height: 28px; border: none; background: var(--gray-100); border-radius: 8px; cursor: pointer; font-size: 1.125rem; color: var(--gray-500); display: flex; align-items: center; justify-content: center; transition: all 0.15s; }
        .pos-modal-close:hover { background: var(--gray-200); color: var(--gray-700); }
        .pos-modal-body { padding: 0 24px 8px; }
        .pos-field { margin-bottom: 14px; }
        .pos-field label { display: block; font-size: 0.75rem; font-weight: 700; color: var(--gray-600); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.04em; }
        .pos-field input { width: 100%; padding: 10px 14px; border: 2px solid var(--gray-200); border-radius: 10px; font-size: 0.9375rem; font-family: 'JetBrains Mono', monospace; font-weight: 600; transition: border-color 0.2s; background: var(--gray-50); }
        .pos-field input:focus { outline: none; border-color: var(--primary); background: white; }
        .pos-field input:disabled { opacity: 0.45; cursor: not-allowed; }
        .pos-quick-label { font-size: 0.6875rem; font-weight: 700; color: var(--gray-500); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.04em; }
        .pos-quick-row { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 14px; }
        .pos-quick-btn { flex: 1; min-width: 0; padding: 7px 4px; border: 1.5px solid var(--gray-200); border-radius: 8px; background: white; font-size: 0.75rem; font-weight: 700; color: var(--gray-700); cursor: pointer; transition: all 0.15s; text-align: center; white-space: nowrap; }
        .pos-quick-btn:hover { border-color: var(--primary-light); color: var(--primary); background: var(--primary-ultra-light); }
        .pos-quick-btn.danger { border-color: #fca5a5; color: #dc2626; }
        .pos-quick-btn.danger:hover { background: #fef2f2; border-color: #ef4444; }
        .pos-quick-btn.success { border-color: #6ee7b7; color: #059669; }
        .pos-quick-btn.success:hover { background: #ecfdf5; border-color: #10b981; }
        .pos-modal-footer { padding: 16px 24px 22px; display: flex; gap: 10px; justify-content: flex-end; }
        .pos-btn-cancel { padding: 9px 20px; border: 2px solid var(--gray-200); border-radius: 10px; background: white; font-size: 0.875rem; font-weight: 700; color: var(--gray-700); cursor: pointer; transition: all 0.15s; }
        .pos-btn-cancel:hover { border-color: var(--gray-300); background: var(--gray-50); }
        .pos-btn-save { padding: 9px 24px; border: none; border-radius: 10px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; font-size: 0.875rem; font-weight: 700; cursor: pointer; transition: all 0.15s; box-shadow: 0 3px 10px rgba(59,130,246,0.3); }
        .pos-btn-save:hover { transform: translateY(-1px); box-shadow: 0 5px 16px rgba(59,130,246,0.4); }
        
        .fund-chart { height: 80px; background: var(--gray-50); border-radius: 10px; overflow: hidden; border: 1px solid var(--gray-200); }
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: rgba(255, 255, 255, 0.5); backdrop-filter: blur(10px); }
        .main-header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(229, 229, 229, 0.6); padding: 24px 32px; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .fund-title-main { font-size: 1.75rem; font-weight: 800; color: var(--gray-900); margin-bottom: 8px; }
        .fund-meta { display: flex; align-items: center; gap: 16px; flex-wrap: wrap; }
        .fund-code-large { font-family: 'JetBrains Mono', monospace; font-size: 0.875rem; color: var(--gray-600); background: var(--gray-50); padding: 6px 14px; border-radius: 10px; font-weight: 600; border: 1px solid var(--gray-200); }
        .market-status { display: flex; align-items: center; gap: 8px; padding: 6px 14px; border-radius: 10px; font-size: 0.8125rem; font-weight: 600; }
        .market-status.open { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
        .market-status.closed { background: var(--gray-50); color: var(--gray-700); border: 1px solid var(--gray-200); }
        .update-time { font-size: 0.8125rem; color: var(--gray-600); background: var(--gray-50); padding: 6px 14px; border-radius: 10px; border: 1px solid var(--gray-200); }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 16px; border: 2px solid var(--gray-200); transition: all 0.3s; position: relative; overflow: hidden; }
        .stat-card:hover { border-color: var(--primary-light); transform: translateY(-4px); box-shadow: 0 8px 24px rgba(59, 130, 246, 0.15); }
        .stat-label { font-size: 0.75rem; color: var(--gray-600); margin-bottom: 8px; text-transform: uppercase; font-weight: 700; display: flex; justify-content: space-between; align-items: center; }
        .stat-value { font-size: 1.875rem; font-weight: 800; font-family: 'JetBrains Mono', monospace; margin-bottom: 6px; }
        .stat-change { font-size: 0.875rem; font-weight: 600; display: flex; align-items: center; gap: 4px; }
        .chart-section { flex: 1; padding: 32px; overflow-y: auto; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .chart-title { font-size: 1.25rem; font-weight: 800; color: var(--gray-900); }
        .time-tabs { display: flex; gap: 8px; background: white; padding: 6px; border-radius: 14px; border: 1px solid var(--gray-200); }
        .time-tab { padding: 8px 18px; border: none; background: transparent; border-radius: 10px; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.2s; color: var(--gray-600); }
        .time-tab.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
        .chart-row { display: flex; gap: 24px; height: 480px; margin-bottom: 24px; }
        .chart-main { flex: 2; min-width: 0; display: flex; flex-direction: column; }
        .chart-side { flex: 1; min-width: 340px; display: flex; flex-direction: column; }
        .chart-container { background: white; border-radius: 20px; padding: 24px; height: 100%; display: flex; flex-direction: column; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06); border: 2px solid var(--gray-100); margin-bottom: 0; }
        #klineChart { width: 100%; flex: 1; min-height: 0; }
        .side-card { background: white; border-radius: 20px; padding: 24px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06); border: 2px solid var(--gray-100); display: flex; flex-direction: column; height: 100%; min-height: 0; overflow: hidden; }
        .table-header { font-size: 1.125rem; font-weight: 800; color: var(--gray-900); margin-bottom: 16px; padding-bottom: 16px; border-bottom: 2px solid var(--gray-100); flex-shrink: 0; }
        .sector-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; flex-shrink: 0; }
        .sector-tag { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; background: var(--gray-50); border: 1px solid var(--gray-200); color: var(--gray-600); }
        .sector-tag.top10-weight { background: rgba(59, 130, 246, 0.08); border-color: rgba(59, 130, 246, 0.22); color: var(--primary-dark); }
        .sector-tag.positive { background: #fef2f2; border-color: #fee2e2; color: #dc2626; }
        .sector-tag.negative { background: #ecfdf5; border-color: #d1fae5; color: #059669; }
        .side-scroll { flex: 1; overflow-y: auto; padding-right: 4px; }
        .side-scroll::-webkit-scrollbar { width: 4px; }
        .side-scroll::-webkit-scrollbar-thumb { background: var(--gray-300); border-radius: 10px; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .side-scroll thead th { position: sticky; top: 0; background: white; z-index: 10; padding: 10px 8px; text-align: left; font-size: 0.75rem; font-weight: 700; color: var(--gray-500); border-bottom: 1px solid var(--gray-200); }
        .data-table-container thead th { padding: 10px 8px; text-align: left; font-size: 0.75rem; font-weight: 700; color: var(--gray-500); border-bottom: 1px solid var(--gray-200); }
        tbody td { padding: 10px 8px; border-bottom: 1px solid var(--gray-50); font-size: 0.875rem; color: var(--gray-800); }
        .side-scroll tbody tr { cursor: pointer; transition: background 0.15s; }
        .side-scroll tbody tr:hover { background: var(--gray-50); }
        .side-scroll tbody tr:hover td:first-child { color: var(--primary); text-decoration: underline; text-underline-offset: 3px; }
        .history-scroll { max-height: 360px; overflow-y: auto; }
        .data-table-container { background: white; border-radius: 20px; padding: 24px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06); border: 2px solid var(--gray-100); }
        .toast { position: fixed; top: 24px; right: 24px; padding: 16px 24px; border-radius: 14px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15); z-index: 10000; animation: slideIn 0.3s ease-out; background: white; border: 2px solid var(--gray-200); }
        .toast.success { border-color: #10b981; background: #ecfdf5; }
        .toast.error { border-color: #ef4444; background: #fef2f2; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .empty-state { text-align: center; padding: 60px 32px; color: var(--gray-500); }
        .empty-icon { font-size: 4rem; margin-bottom: 16px; opacity: 0.5; }
        .empty-text { font-size: 1.125rem; font-weight: 600; color: var(--gray-700); margin-bottom: 8px; }
        .empty-subtext { font-size: 0.9375rem; }
        
        /* æ•°æ®æºçŠ¶æ€æŒ‡ç¤ºå™¨ */
        .source-indicator { position: fixed; bottom: 20px; left: 20px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 12px 16px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid var(--gray-200); font-size: 0.8125rem; z-index: 100; display: flex; align-items: center; gap: 8px; cursor: pointer; transition: all 0.3s; }
        .source-indicator:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.15); }
        .source-indicator .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #10b981; animation: pulse 2s infinite; }
        .source-indicator .status-text { font-weight: 600; color: var(--gray-700); }
        .source-indicator .source-name { font-family: 'JetBrains Mono', monospace; color: var(--gray-500); font-size: 0.75rem; }
        
        /* æ•°æ®æºç»Ÿè®¡å¼¹çª— */
        .source-stats-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 10001; display: none; align-items: center; justify-content: center; }
        .source-stats-modal.active { display: flex; }
        .source-stats-content { background: white; border-radius: 20px; padding: 32px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .source-stats-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid var(--gray-100); }
        .source-stats-title { font-size: 1.25rem; font-weight: 800; }
        .source-stats-close { width: 32px; height: 32px; border: none; background: var(--gray-100); border-radius: 8px; cursor: pointer; font-size: 1.25rem; }
        .source-stats-table { width: 100%; }
        .source-stats-table th { text-align: left; padding: 10px; background: var(--gray-50); font-size: 0.75rem; font-weight: 700; color: var(--gray-600); }
        .source-stats-table td { padding: 12px 10px; border-bottom: 1px solid var(--gray-100); font-size: 0.875rem; }
        .source-stats-table .success-rate { font-weight: 700; }
        .source-stats-table .success-rate.high { color: #10b981; }
        .source-stats-table .success-rate.medium { color: #f59e0b; }
        .source-stats-table .success-rate.low { color: #ef4444; }
        
        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 1200px) { 
            .chart-row { height: auto; flex-direction: column; } 
            .chart-container { height: 400px; margin-bottom: 24px; } 
            .chart-side { min-width: 100%; }
            .side-card { height: 400px; } 
            .stats-grid { grid-template-columns: repeat(2, 1fr); } 
        }
        
        @media (max-width: 768px) { 
            .mobile-menu-btn { display: flex; }
            .sidebar { 
                width: 100%; 
                max-width: 380px;
                position: fixed; 
                z-index: 1000; 
                height: 100vh;
                transform: translateX(-100%); 
                transition: transform 0.3s; 
            }
            .sidebar.open { transform: translateX(0); }
            .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999; }
            .sidebar-overlay.active { display: block; }
            .main-content { margin-left: 0; }
            .main-header { padding: 80px 16px 16px; }
            .fund-title-main { font-size: 1.25rem; }
            .stats-grid { grid-template-columns: 1fr; gap: 12px; }
            .stat-card { padding: 16px; }
            .stat-value { font-size: 1.5rem; }
            .chart-section { padding: 16px; }
            .chart-container { padding: 16px; }
            .side-card { padding: 16px; }
            .fund-meta { gap: 8px; }
            .chart-header { flex-direction: column; align-items: flex-start; gap: 12px; }
            .time-tabs { width: 100%; justify-content: space-between; }
            .time-tab { padding: 8px 12px; font-size: 0.8125rem; }
            .input-row { grid-template-columns: 1fr; }
            .btn-add { width: 100%; }
            .source-indicator { display: none; } /* ç§»åŠ¨ç«¯éšè—æ•°æ®æºæŒ‡ç¤ºå™¨ */
            .market-indices { padding: 0; }
            .indices-toggle { padding: 12px 16px; }
            .indices-inner { padding: 16px; }
            /* ç§»åŠ¨ç«¯æ¢å¤1åˆ— */
            .indices-grid { grid-template-columns: 1fr; gap: 8px; }
            .index-card { padding: 10px 12px; min-height: auto; }
            .index-card.selected { grid-column: span 1; }
            .index-value { font-size: 1rem; }
        }
        
        @media (max-width: 480px) {
            .optional-inputs { grid-template-columns: 1fr; }
            .fund-code-large, .market-status, .update-time { font-size: 0.75rem; padding: 4px 10px; }
        }
    </style>
</head>
<body>
    <button class="mobile-menu-btn" id="mobileMenuBtn">
        <span></span>
        <span></span>
        <span></span>
    </button>
    
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
    <div class="source-indicator" id="sourceIndicator">
        <div class="status-dot"></div>
        <div class="status-text">æ•°æ®æºè¿è¡Œä¸­</div>
        <div class="source-name" id="currentSourceName">fundgz_jsonp</div>
    </div>
    
    <div class="source-stats-modal" id="sourceStatsModal">
        <div class="source-stats-content">
            <div class="source-stats-header">
                <h3 class="source-stats-title">ğŸ“Š æ•°æ®æºç»Ÿè®¡</h3>
                <button class="source-stats-close" onclick="closeSourceStats()">Ã—</button>
            </div>
            <table class="source-stats-table">
                <thead>
                    <tr>
                        <th>æ•°æ®æº</th>
                        <th>æˆåŠŸ</th>
                        <th>å¤±è´¥</th>
                        <th>æˆåŠŸç‡</th>
                        <th>å¹³å‡è€—æ—¶</th>
                    </tr>
                </thead>
                <tbody id="sourceStatsTableBody">
                    <tr><td colspan="5" style="text-align: center; padding: 20px; color: var(--gray-500);">æš‚æ— æ•°æ®</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- æŒä»“ç¼–è¾‘å¯¹è¯æ¡† -->
    <div class="pos-modal-overlay" id="posModalOverlay" onclick="posModalBgClick(event)">
        <div class="pos-modal">
            <div class="pos-modal-header">
                <div class="pos-modal-title" id="posModalTitle">ç¼–è¾‘æŒä»“</div>
                <button class="pos-modal-close" onclick="closePosModal()">Ã—</button>
            </div>
            <div class="pos-modal-body">
                <div class="pos-field">
                    <label>åŸºé‡‘ä»£ç </label>
                    <input type="text" id="posCode" disabled>
                </div>
                <div class="pos-field">
                    <label>æŒä»“æˆæœ¬ï¼ˆæ¯ä»½ä¹°å…¥ä»·ï¼‰</label>
                    <input type="number" id="posCost" placeholder="å¦‚ 1.5200" step="0.0001">
                </div>
                <div class="pos-field">
                    <label>æŒä»“ä»½é¢</label>
                    <input type="number" id="posShares" placeholder="å¦‚ 10000">
                </div>
                <div class="pos-quick-label">å¿«é€Ÿæ“ä½œ</div>
                <div class="pos-quick-row">
                    <button class="pos-quick-btn danger" onclick="posQuickAction('clear')">æ¸…ä»“</button>
                    <button class="pos-quick-btn" onclick="posQuickAction('half')">1/2</button>
                    <button class="pos-quick-btn" onclick="posQuickAction('third')">1/3</button>
                    <button class="pos-quick-btn" onclick="posQuickAction('quarter')">1/4</button>
                    <button class="pos-quick-btn success" onclick="posQuickAction('double')">2Ã—</button>
                </div>
            </div>
            <div class="pos-modal-footer">
                <button class="pos-btn-cancel" onclick="closePosModal()">å–æ¶ˆ</button>
                <button class="pos-btn-save" onclick="savePosModal()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div class="app-container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo-card">
                    <div class="logo-content">
                        <div class="logo-icon">ğŸ“ˆ</div>
                        <div class="logo">FundFlow</div>
                        <div class="logo-subtitle"><span class="status-indicator"></span><span>å®æ—¶ç›‘æ§ç³»ç»Ÿ</span></div>
                    </div>
                </div>
            </div>
            
            <div class="market-indices">
                <button class="indices-toggle" onclick="toggleIndices()">
                    <div class="indices-toggle-left">
                        <div class="indices-title">
                            <span>ğŸ“Š</span>
                            <span>å¸‚åœºæŒ‡æ•°</span>
                        </div>
                    </div>
                    <span class="indices-arrow" id="indicesArrow">â–¼</span>
                </button>
                
                <div class="indices-content" id="indicesContent">
                    <div class="indices-inner">
                        <div class="indices-grid" id="indicesGrid">
                            </div>
                        <button class="indices-refresh" onclick="fetchMarketIndices()">ğŸ”„ åˆ·æ–°æŒ‡æ•°</button>
                    </div>
                </div>
            </div>
            
            <div class="add-fund-section" style="padding:0; border-bottom:none;">
                <button class="add-fund-toggle" onclick="toggleAddFund()">
                    <div class="add-fund-toggle-left">
                        <span>ï¼‹</span>
                        <span class="add-fund-toggle-title">æ·»åŠ åŸºé‡‘</span>
                    </div>
                    <span class="add-fund-arrow" id="addFundArrow">â–¼</span>
                </button>
                <div class="add-fund-body" id="addFundBody">
                    <div class="add-fund-inner">
                        <div class="input-row">
                            <input type="text" id="fundCode" class="input-field" placeholder="è¾“å…¥åŸºé‡‘ä»£ç ">
                            <button onclick="addFund()" class="btn-add">æ·»åŠ </button>
                        </div>
                        <div class="fund-suggest" id="fundSuggest"></div>
                        <div class="optional-inputs">
                            <input type="number" id="holdingCost" class="input-field input-small" placeholder="æŒä»“æˆæœ¬(å¯é€‰)">
                            <input type="number" id="holdingShares" class="input-field input-small" placeholder="æŒä»“ä»½é¢(å¯é€‰)">
                        </div>
                        <div class="helper-text"><span>ğŸ’¡</span><span>è¾“å…¥æŒä»“ä¿¡æ¯å¯æŸ¥çœ‹æ”¶ç›Šè¯¦æƒ…</span></div>
                    </div>
                </div>
            </div>
            <div class="fund-list" id="fundList"></div>
        </aside>

        <main class="main-content">
            <div class="main-header">
                <div class="header-top">
                    <div class="fund-title-section">
                        <h1 class="fund-title-main" id="selectedFundName">é€‰æ‹©ä¸€ä¸ªåŸºé‡‘å¼€å§‹ç›‘æ§</h1>
                        <div class="fund-meta">
                            <span class="fund-code-large" id="selectedFundCode">--</span>
                            <div class="market-status closed" id="marketStatus"><span>â¸</span><span id="marketStatusText">ä¼‘å¸‚ä¸­</span></div>
                            <div class="update-time" id="updateTime">--</div>
                        </div>
                    </div>
                    <button class="header-collapse-btn" id="headerCollapseBtn" onclick="toggleHeaderStats()" title="æŠ˜å /å±•å¼€">â–¼</button>
                </div>
                <div class="stats-grid-wrapper" id="statsGridWrapper">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">å½“å‰å‡€å€¼ <span id="navDateLabel" style="background:var(--gray-100); padding:2px 6px; border-radius:4px; font-weight:500; font-size:0.65rem;">--</span></div>
                            <div class="stat-value" id="currentNav">--</div>
                            <div class="stat-change" id="navChange">--</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label"><span id="estLabel">ä¼°ç®—å‡€å€¼</span></div>
                            <div class="stat-value" id="estimatedNav">--</div>
                            <div class="stat-change" id="estimatedChange">--</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">æ—¥æ¶¨è·Œå¹…</div>
                            <div class="stat-value" id="dayGrowth">--</div>
                            <div class="stat-change" id="dayGrowthChange">--<span class="day-growth-source official" id="dayGrowthSource"></span></div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">æŒä»“æ”¶ç›Š</div>
                            <div class="stat-value" id="totalProfit">--</div>
                            <div class="stat-change" id="profitPercent">--</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="chart-section">
                <div class="chart-header">
                    <h2 class="chart-title" id="chartTypeLabel">å‡€å€¼èµ°åŠ¿å›¾</h2>
                    <div class="time-tabs">
                        <button class="time-tab active" onclick="changeTimeRange('realtime')">å®æ—¶</button>
                        <button class="time-tab" onclick="changeTimeRange('5d')">1å‘¨</button>
                        <button class="time-tab" onclick="changeTimeRange('1m')">1æœˆ</button>
                        <button class="time-tab" onclick="changeTimeRange('3m')">3æœˆ</button>
                        <button class="time-tab" onclick="changeTimeRange('1y')">1å¹´</button>
                        <button class="time-tab" onclick="changeTimeRange('all')">æˆç«‹æ¥</button>
                    </div>
                </div>
                <div class="chart-row">
                    <div class="chart-main">
                        <div class="chart-container"><div id="klineChart"></div></div>
                    </div>
                    <div class="chart-side">
                        <div class="side-card">
                            <div class="table-header">åŸºé‡‘æŒä»“ï¼ˆTOP 10ï¼‰</div>
                            <div id="sectorTags" class="sector-tags"><span style="font-size: 0.8125rem; color: var(--gray-500);">æš‚æ— æ•°æ®</span></div>
                            <div class="side-scroll">
                                <table>
                                    <thead><tr><th>è‚¡ç¥¨</th><th>ä»£ç </th><th>å æ¯”</th><th>æ¶¨è·Œå¹…</th></tr></thead>
                                    <tbody id="holdingsTableBody"><tr><td colspan="4" style="text-align: center; color: var(--gray-500); padding: 40px;">è¯·é€‰æ‹©åŸºé‡‘</td></tr></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="data-table-container">
                    <div class="table-header">å†å²å‡€å€¼æ•°æ®</div>
                    <div class="history-scroll" id="historyScroll">
                        <table>
                            <thead><tr><th>æ—¥æœŸ</th><th>å•ä½å‡€å€¼</th><th>ç´¯è®¡å‡€å€¼</th><th>æ—¥å¢é•¿ç‡</th></tr></thead>
                            <tbody id="historyTableBody"><tr><td colspan="4" style="text-align: center; color: var(--gray-500); padding: 40px;">æš‚æ— æ•°æ®</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let funds = JSON.parse(localStorage.getItem('funds') || '[]');
        let selectedFund = null;
        let holdingsCache = {}; // { [fundCode]: { holdings: [{code, ratio, chg}], top10Weight, top10Contribution, estDayChg, timestamp } }
        let chart = null;
        let miniCharts = {};
        let updateInterval = null;
        let realtimeInterval = null;
        let currentTimeRange = 'realtime';
        let historyCache = {}; // { [fundCode]: [{x, y}, ...] } ç¼“å­˜ pingzhongdata å…¨éƒ¨å†å²
        let historyTableState = { code: null, rendered: 0, pageSize: 10 };
        let fundgzQueue = Promise.resolve();
        let marketIndices = {};
        let selectedIndexKey = null;
        let indexCharts = {};
        let refreshInterval = null;
        let refreshLock = Promise.resolve();
        let lastFundRefreshAt = 0;
        let lastIndicesRefreshAt = 0;
        let lastHoldingsRefreshAt = 0;
        let refreshTick = 0;
        let fundRefreshCursor = 0;

        // æ·»åŠ åŸºé‡‘åŒºåŸŸæŠ˜å 
        function toggleAddFund() {
            const body = document.getElementById('addFundBody');
            const arrow = document.getElementById('addFundArrow');
            body.classList.toggle('open');
            arrow.classList.toggle('open');
        }

        // ============================================================
        // æŒä»“ç¼–è¾‘å¯¹è¯æ¡†
        // ============================================================
        let _posEditCode = null; // å½“å‰æ­£åœ¨ç¼–è¾‘çš„åŸºé‡‘ä»£ç 

        function openPosModal(code) {
            const fund = funds.find(f => f.code === code);
            if (!fund) return;
            _posEditCode = code;
            document.getElementById('posModalTitle').textContent = `ç¼–è¾‘æŒä»“ â€” ${fund.name || code}`;
            document.getElementById('posCode').value = code;
            document.getElementById('posCost').value = fund.holdingCost != null ? fund.holdingCost : '';
            document.getElementById('posShares').value = fund.holdingShares != null ? fund.holdingShares : '';
            document.getElementById('posModalOverlay').classList.add('active');
            // çŸ­å»¶è¿Ÿå focus æˆæœ¬è¾“å…¥æ¡†
            setTimeout(() => document.getElementById('posCost').focus(), 120);
        }

        function closePosModal() {
            document.getElementById('posModalOverlay').classList.remove('active');
            _posEditCode = null;
        }

        function posModalBgClick(e) {
            if (e.target === document.getElementById('posModalOverlay')) closePosModal();
        }

        function savePosModal() {
            if (!_posEditCode) return;
            const fund = funds.find(f => f.code === _posEditCode);
            if (!fund) return;
            const costVal = document.getElementById('posCost').value.trim();
            const sharesVal = document.getElementById('posShares').value.trim();
            fund.holdingCost = costVal !== '' ? parseFloat(costVal) : null;
            fund.holdingShares = sharesVal !== '' ? parseFloat(sharesVal) : null;
            // æ ¡éªŒ NaN
            if (fund.holdingCost !== null && isNaN(fund.holdingCost)) fund.holdingCost = null;
            if (fund.holdingShares !== null && isNaN(fund.holdingShares)) fund.holdingShares = null;
            saveFunds();
            closePosModal();
            renderFundList();
            if (selectedFund?.code === _posEditCode || selectedFund?.code === fund.code) updateMainDisplay(fund);
            showToast('æŒä»“ä¿¡æ¯å·²æ›´æ–°');
        }

        function posQuickAction(action) {
            const sharesInput = document.getElementById('posShares');
            const current = parseFloat(sharesInput.value) || 0;
            switch (action) {
                case 'clear':
                    sharesInput.value = '0';
                    break;
                case 'half':
                    sharesInput.value = Math.floor(current / 2);
                    break;
                case 'third':
                    sharesInput.value = Math.floor(current / 3);
                    break;
                case 'quarter':
                    sharesInput.value = Math.floor(current / 4);
                    break;
                case 'double':
                    sharesInput.value = current * 2;
                    break;
            }
            sharesInput.dispatchEvent(new Event('input'));
        }

        // ä¸»é¡µæ ‡é¢˜æ  stats æŠ˜å /å±•å¼€
        function toggleHeaderStats() {
            const wrapper = document.getElementById('statsGridWrapper');
            const btn = document.getElementById('headerCollapseBtn');
            if (!wrapper) return;
            wrapper.classList.toggle('collapsed');
            if (btn) btn.textContent = wrapper.classList.contains('collapsed') ? 'â–²' : 'â–¼';
        }

        // æŠ˜å /å±•å¼€å¸‚åœºæŒ‡æ•°
        function toggleIndices() {
            const content = document.getElementById('indicesContent');
            const arrow = document.getElementById('indicesArrow');
            content.classList.toggle('open');
            arrow.classList.toggle('open');
            if (content.classList.contains('open') && Object.keys(marketIndices).length === 0) {
                fetchMarketIndices();
            }
        }

        // å¸‚åœºæŒ‡æ•°é…ç½®
        const MARKET_INDICES = {
            sh000001: { name: 'ä¸Šè¯æŒ‡æ•°', flag: 'ğŸ‡¨ğŸ‡³', secid: '1.000001', type: 'cn' },
            sz399001: { name: 'æ·±è¯æˆæŒ‡', flag: 'ğŸ‡¨ğŸ‡³', secid: '0.399001', type: 'cn' },
            sz399006: { name: 'åˆ›ä¸šæ¿æŒ‡', flag: 'ğŸ‡¨ğŸ‡³', secid: '0.399006', type: 'cn' },
            us_dji: { name: 'é“ç¼æ–¯', flag: 'ğŸ‡ºğŸ‡¸', secid: '100.DJIA', type: 'us' },
            us_ixic: { name: 'çº³æ–¯è¾¾å…‹', flag: 'ğŸ‡ºğŸ‡¸', secid: '100.NDX', type: 'us' },
            us_spx: { name: 'æ ‡æ™®500', flag: 'ğŸ‡ºğŸ‡¸', secid: '100.SPX', type: 'us' }
        };

        async function fetchMarketIndices() {
            const grid = document.getElementById('indicesGrid');
            if (!grid) return;

            const indexSources = [
                {
                    name: 'eastmoney_api',
                    fetch: async (secid) => {
                        const url = `https://push2.eastmoney.com/api/qt/stock/get?secid=${secid}&fields=f43,f3,f169,f170,f60,f86&_=${Date.now()}`;
                        return await runWithSourceStat('index_stock_get_jsonp', async () => await fetchJsonp(url, 'cb', 12000));
                    }
                }
            ];

            const indexCards = [];
            
            for (const [key, config] of Object.entries(MARKET_INDICES)) {
                let data = null;
                
                for (const source of indexSources) {
                    try {
                        const result = await Promise.race([
                            source.fetch(config.secid),
                            new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 8000))
                        ]);
                        if (result?.data) { data = result.data; break; }
                    } catch (error) {
                        console.warn(`[æŒ‡æ•°-${config.name}-${source.name}] å¤±è´¥:`, error.message);
                        continue;
                    }
                }

                if (data) {
                    const price = data.f43 || data.f60;
                    const isCn = config.type === 'cn';
                    let isClosed = false;
                    if (isCn) {
                        const s = getMarketStatus();
                        isClosed = !s.isOpen;
                    } else {
                        const today = new Date();
                        const day = today.getDay();
                        if (day === 0 || day === 6) isClosed = true;
                    }

                    let changePct = 0;
                    // Aè‚¡åœ¨ä¼‘å¸‚æ—¶ï¼šç”¨æœ€è¿‘æ”¶ç›˜å£å¾„ï¼ˆæ”¶ç›˜ä»· vs æ˜¨æ”¶ï¼‰
                    if (isCn && isClosed) {
                        const closeRaw = data.f43;
                        const preCloseRaw = data.f60;
                        if (Number.isFinite(closeRaw) && Number.isFinite(preCloseRaw) && preCloseRaw !== 0) {
                            changePct = (closeRaw - preCloseRaw) / preCloseRaw * 100;
                        } else if (data.f170 && price) {
                            const preClose = price - data.f170;
                            if (preClose) changePct = (data.f170 / preClose) * 100;
                        } else if (data.f3 !== undefined && data.f3 !== null && data.f3 !== '-') {
                            changePct = data.f3;
                        }
                    } else {
                        // äº¤æ˜“ä¸­ï¼ˆæˆ–éAè‚¡æŒ‡æ•°ï¼‰ï¼šä¼˜å…ˆç”¨æ¥å£å®æ—¶æ¶¨è·Œå¹…
                        if (data.f3 !== undefined && data.f3 !== null && data.f3 !== '-') {
                            changePct = data.f3;
                        } else if (data.f170 && price) {
                            const preClose = price - data.f170;
                            if (preClose) changePct = (data.f170 / preClose) * 100;
                        }
                    }
                    const updateTime = data.f86 || '--';
                    const isPositive = changePct >= 0;
                    const finalPrice = price > 10000 && config.type === 'cn' ? (price/100).toFixed(2) : (price/100).toFixed(2);
                    const formattedChange = (changePct !== undefined) ? (isPositive ? '+' : '') + parseFloat(changePct).toFixed(2) + '%' : '--';
                    
                    let timeStr = '--';
                    if (updateTime && updateTime !== '--') {
                        const d = new Date(updateTime * 1000);
                        timeStr = `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
                    }
                    
                    marketIndices[key] = { price: finalPrice, change: changePct, changePct: formattedChange, time: timeStr, secid: config.secid, name: config.name };
                    
                    indexCards.push(`
                        <div class="index-card ${isPositive ? 'positive' : 'negative'} ${selectedIndexKey === key ? 'selected' : ''} ${isClosed ? 'closed' : ''}" 
                             onclick="selectIndex('${key}')" id="indexCard_${key}">
                            <div class="index-header">
                                <div class="index-name"><span class="index-flag">${config.flag}</span>${config.name}</div>
                                <span class="index-status-badge">ä¼‘å¸‚</span>
                            </div>
                            <div class="index-body">
                                <div class="index-value">${finalPrice}</div>
                                <div class="index-change">${formattedChange}</div>
                            </div>
                            <div class="index-chart-container" id="chartContainer_${key}" style="display: none;">
                                <div class="index-mini-chart" id="indexChart_${key}"></div>
                            </div>
                        </div>
                    `);
                } else {
                    indexCards.push(`
                        <div class="index-card">
                            <div class="index-header"><div class="index-name"><span class="index-flag">${config.flag}</span>${config.name}</div></div>
                            <div class="index-body"><div class="index-value">---</div><div class="index-change">åŠ è½½å¤±è´¥</div></div>
                        </div>
                    `);
                }
            }
            grid.innerHTML = indexCards.join('');
        }
        
        async function selectIndex(key) {
            if (selectedIndexKey) {
                const prevCard = document.getElementById(`indexCard_${selectedIndexKey}`);
                const prevContainer = document.getElementById(`chartContainer_${selectedIndexKey}`);
                if (prevCard) prevCard.classList.remove('selected');
                if (prevContainer) prevContainer.style.display = 'none';
            }
            if (selectedIndexKey === key) { selectedIndexKey = null; return; }
            
            selectedIndexKey = key;
            const card = document.getElementById(`indexCard_${key}`);
            const container = document.getElementById(`chartContainer_${key}`);
            
            if (card) card.classList.add('selected');
            if (container) {
                container.style.display = 'block';
                if (indexCharts[key]) indexCharts[key].dispose();
                await fetchAndDrawIndexKline(key);
            }
        }
        
        function parseTrendTime(str) {
            if (!str) return '';
            let match = str.match(/(\d{2}):(\d{2})/);
            if (match) return `${match[1]}:${match[2]}`;
            if (str.length >= 12 && !isNaN(str)) return str.substring(8, 10) + ':' + str.substring(10, 12);
            return str;
        }

        function isAshareTradingTimeLabel(hhmm) {
            const m = (hhmm || '').match(/^(\d{2}):(\d{2})$/);
            if (!m) return true;
            const min = parseInt(m[1], 10) * 60 + parseInt(m[2], 10);
            return (min >= 570 && min <= 690) || (min >= 780 && min <= 900);
        }

        async function fetchAndDrawIndexKline(key) {
            const config = MARKET_INDICES[key];
            if (!config) return;
            const chartDom = document.getElementById(`indexChart_${key}`);
            if (!chartDom) return;
            
            const klineSources = [
                {
                    name: 'eastmoney_trend',
                    fetch: async () => {
                        const url = `https://push2.eastmoney.com/api/qt/stock/trends2/get?secid=${config.secid}&fields1=f1,f2,f3,f4,f5,f6,f7,f8,f9,f10,f11,f12,f13&fields2=f51,f53&_=${Date.now()}`;
                        return await runWithSourceStat('index_trends2_jsonp', async () => await fetchJsonp(url, 'cb', 12000));
                    }
                }
            ];
            
            let trendData = null;
            for (const source of klineSources) {
                try {
                    const result = await source.fetch();
                    if (result?.data?.trends) { trendData = result.data; break; }
                } catch (error) {
                    console.warn(`[Kçº¿-${config.name}-${source.name}] å¤±è´¥:`, error.message);
                    continue;
                }
            }
            
            if (!trendData || !trendData.trends) {
                chartDom.innerHTML = '<div style="text-align:center;color:var(--gray-500);padding:60px 0;font-size:0.75rem;">æš‚æ— æ•°æ®</div>';
                return;
            }
            
            const times = [];
            const prices = [];
            const preClose = trendData.preClose;
            
            trendData.trends.forEach(item => {
                const parts = item.split(',');
                const t = parseTrendTime(parts[0]);
                if (config.type === 'cn' && !isAshareTradingTimeLabel(t)) return;
                const p = parseFloat(parts[1]);
                if (!Number.isFinite(p)) return;
                times.push(t);
                prices.push(p);
            });
            
            const indexChart = echarts.init(chartDom);
            indexCharts[key] = indexChart;
            
            indexChart.setOption({
                grid: { left: 30, right: 22, top: 10, bottom: 28, containLabel: true },
                xAxis: {
                    type: 'category', data: times, boundaryGap: true,
                    axisLabel: {
                        fontSize: 9,
                        color: '#999',
                        margin: 8,
                        interval: (index) => {
                            const total = times.length;
                            if (total <= 6) return true;
                            const step = Math.max(1, Math.floor(total / 4));
                            if (index === 0 || index === total - 1) return true;
                            return index % step === 0;
                        },
                        showMinLabel: true,
                        showMaxLabel: true
                    },
                    axisLine: { lineStyle: { color: '#e5e5e5' } }, axisTick: { show: false }
                },
                yAxis: { type: 'value', scale: true, splitLine: { show: false }, axisLabel: { show: false }, axisLine: { show: false }, axisTick: { show: false } },
                series: [{
                    type: 'line', data: prices, smooth: true, symbol: 'none',
                    lineStyle: { width: 1.5, color: prices[prices.length - 1] >= preClose ? '#dc2626' : '#059669' },
                    areaStyle: { color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{ offset: 0, color: prices[prices.length - 1] >= preClose ? 'rgba(220, 38, 38, 0.1)' : 'rgba(5, 150, 105, 0.1)' }, { offset: 1, color: 'rgba(255, 255, 255, 0)' }]) }
                }],
                tooltip: {
                    trigger: 'axis', confine: true,
                    backgroundColor: 'rgba(255, 255, 255, 0.95)', borderColor: '#e5e5e5', textStyle: { fontSize: 10 },
                    formatter: (params) => { const param = params[0]; const change = ((param.data - preClose) / preClose * 100).toFixed(2); return `${param.name}<br/>${param.data.toFixed(2)} (${change >= 0 ? '+' : ''}${change}%)`; }
                }
            });
        }

        // ç§»åŠ¨ç«¯èœå•æ§åˆ¶
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        
        mobileMenuBtn?.addEventListener('click', () => { mobileMenuBtn.classList.toggle('active'); sidebar.classList.toggle('open'); sidebarOverlay.classList.toggle('active'); });
        sidebarOverlay?.addEventListener('click', () => { mobileMenuBtn.classList.remove('active'); sidebar.classList.remove('open'); sidebarOverlay.classList.remove('active'); });

        // å¤šæ•°æ®æºé…ç½®
        function ensureSourceStat(name) {
            if (!name) return;
            if (!sourceStats[name]) sourceStats[name] = { success: 0, fail: 0, totalTime: 0 };
        }

        async function runWithSourceStat(name, fn) {
            ensureSourceStat(name);
            const startTime = Date.now();
            try {
                const data = await fn();
                const duration = Date.now() - startTime;
                sourceStats[name].success++;
                sourceStats[name].totalTime += duration;
                updateSourceIndicator(name);
                return data;
            } catch (error) {
                const duration = Date.now() - startTime;
                sourceStats[name].fail++;
                throw error;
            }
        }

        function fetchJsonp(url, callbackParam, timeoutMs = 10000) {
            return new Promise((resolve, reject) => {
                const cbName = `__ff_jsonp_${Date.now()}_${Math.random().toString(16).slice(2)}`;
                const script = document.createElement('script');
                const sep = url.includes('?') ? '&' : '?';
                const timer = setTimeout(() => {
                    cleanup();
                    reject(new Error('timeout'));
                }, timeoutMs);
                const cleanup = () => {
                    clearTimeout(timer);
                    try { delete window[cbName]; } catch { window[cbName] = undefined; }
                    script.remove();
                };
                window[cbName] = (data) => {
                    cleanup();
                    resolve(data);
                };
                script.onerror = () => {
                    cleanup();
                    reject(new Error('script load failed'));
                };
                script.src = `${url}${sep}${callbackParam}=${cbName}`;
                document.head.appendChild(script);
            });
        }

        function loadScript(url, timeoutMs = 12000) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                const timer = setTimeout(() => {
                    cleanup();
                    reject(new Error('timeout'));
                }, timeoutMs);
                const cleanup = () => {
                    clearTimeout(timer);
                    script.remove();
                };
                script.onload = () => {
                    cleanup();
                    resolve();
                };
                script.onerror = () => {
                    cleanup();
                    reject(new Error('script load failed'));
                };
                script.src = url;
                document.head.appendChild(script);
            });
        }

        async function fetchApidataViaScript(url, sourceName) {
            return await runWithSourceStat(sourceName, async () => {
                try { delete window.apidata; } catch { window.apidata = undefined; }
                await loadScript(url, 12000);
                const d = window.apidata;
                if (!d) throw new Error('no apidata');
                try { delete window.apidata; } catch { window.apidata = undefined; }
                return d;
            });
        }

        const DATA_SOURCES = {
            fundgz_jsonp: {
                name: 'fundgz_jsonp', priority: 1,
                fetch: async (code) => {
                    return await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        const prev = window.jsonpgz;
                        const timeout = setTimeout(() => { window.jsonpgz = prev; script.remove(); reject(new Error('timeout')); }, 8000);
                        window.jsonpgz = (data) => { clearTimeout(timeout); window.jsonpgz = prev; script.remove(); resolve(data); };
                        script.onerror = () => { clearTimeout(timeout); window.jsonpgz = prev; script.remove(); reject(new Error('script load failed')); };
                        script.src = `https://fundgz.1234567.com.cn/js/${code}.js?rt=${Date.now()}`;
                        document.head.appendChild(script);
                    });
                }
            },
            ttjj_api_jsonp: {
                name: 'ttjj_api_jsonp', priority: 2,
                fetch: async (code) => {
                    const url = `https://api.fund.eastmoney.com/f10/lsjz?fundCode=${code}&pageIndex=1&pageSize=1&_=${Date.now()}`;
                    const json = await fetchJsonp(url, 'callback', 12000);
                    const latest = json?.Data?.LSJZList?.[0];
                    if (!latest) throw new Error('No data');
                    return { name: json.Data.SHORTNAME || code, dwjz: latest.DWJZ, jzrq: latest.FSRQ, gsz: latest.DWJZ, gszzl: latest.JZZZL || '0.00', gztime: latest.FSRQ + ' 15:00' };
                }
            },
            pingzhongdata_script: {
                name: 'pingzhongdata_script', priority: 3,
                fetch: async (code) => {
                    await loadScript(`https://fund.eastmoney.com/pingzhongdata/${code}.js?rt=${Date.now()}`, 12000);
                    const name = (window.fS_name || window.fSName || '').toString();
                    const navData = window.Data_netWorthTrend;
                    if (!name || !Array.isArray(navData) || navData.length === 0) throw new Error('Parse failed');
                    const latest = navData[navData.length - 1];
                    const prev = navData.length >= 2 ? navData[navData.length - 2] : null;
                    const dwjz = latest?.y;
                    const jzrq = new Date(latest?.x).toISOString().split('T')[0];
                    let gszzl = '0.00';
                    if (prev && prev.y) gszzl = (((latest.y - prev.y) / prev.y) * 100).toFixed(2);
                    return { name, dwjz: String(dwjz), jzrq, gsz: String(dwjz), gszzl, gztime: jzrq + ' 15:00' };
                }
            }
        };

        const sourceStats = {};
        Object.values(DATA_SOURCES).forEach(s => ensureSourceStat(s.name));

        async function fetchWithFallback(code) {
            const sources = Object.values(DATA_SOURCES).sort((a, b) => {
                ensureSourceStat(a.name);
                ensureSourceStat(b.name);
                const aSuccessRate = sourceStats[a.name].success / (sourceStats[a.name].success + sourceStats[a.name].fail || 1);
                const bSuccessRate = sourceStats[b.name].success / (sourceStats[b.name].success + sourceStats[b.name].fail || 1);
                if (Math.abs(aSuccessRate - bSuccessRate) > 0.1) return bSuccessRate - aSuccessRate;
                return a.priority - b.priority;
            });
            
            let lastError;
            for (const source of sources) {
                const startTime = Date.now();
                try {
                    console.log(`ğŸ”„ [${source.name}] å°è¯•è·å–æ•°æ®...`);
                    const data = await source.fetch(code);
                    const duration = Date.now() - startTime;
                    if (!data || !data.dwjz || !data.name) throw new Error('æ•°æ®ä¸å®Œæ•´');
                    ensureSourceStat(source.name);
                    sourceStats[source.name].success++;
                    sourceStats[source.name].totalTime += duration;
                    console.log(`âœ… [${source.name}] æˆåŠŸï¼è€—æ—¶: ${duration}ms`);
                    updateSourceIndicator(source.name);
                    return data;
                } catch (error) {
                    const duration = Date.now() - startTime;
                    ensureSourceStat(source.name);
                    sourceStats[source.name].fail++;
                    console.warn(`âŒ [${source.name}] å¤±è´¥: ${error.message} (${duration}ms)`);
                    lastError = error;
                    if (source !== sources[sources.length - 1]) { await new Promise(resolve => setTimeout(resolve, 200)); continue; }
                }
            }
            throw lastError || new Error('æ‰€æœ‰æ•°æ®æºå‡å¤±è´¥');
        }

        function showSourceStats() { console.table(Object.entries(sourceStats).map(([name, stats]) => ({ æ•°æ®æº: name, æˆåŠŸ: stats.success, å¤±è´¥: stats.fail, æˆåŠŸç‡: stats.success + stats.fail > 0 ? ((stats.success / (stats.success + stats.fail)) * 100).toFixed(1) + '%' : 'N/A', å¹³å‡è€—æ—¶: stats.success > 0 ? (stats.totalTime / stats.success).toFixed(0) + 'ms' : 'N/A' }))); }
        window.showSourceStats = showSourceStats;
        
        let lastSuccessfulSource = 'fundgz_jsonp';
        document.getElementById('sourceIndicator')?.addEventListener('click', () => { openSourceStatsModal(); });
        
        function openSourceStatsModal() {
            const modal = document.getElementById('sourceStatsModal');
            const tbody = document.getElementById('sourceStatsTableBody');
            const statsData = Object.entries(sourceStats).map(([name, stats]) => ({ name, success: stats.success, fail: stats.fail, successRate: stats.success + stats.fail > 0 ? ((stats.success / (stats.success + stats.fail)) * 100).toFixed(1) : 'N/A', avgTime: stats.success > 0 ? (stats.totalTime / stats.success).toFixed(0) : 'N/A' })).sort((a, b) => (parseFloat(b.successRate) || 0) - (parseFloat(a.successRate) || 0));
            tbody.innerHTML = statsData.map(stat => { const rate = parseFloat(stat.successRate) || 0; const rateClass = rate >= 80 ? 'high' : rate >= 50 ? 'medium' : 'low'; return `<tr><td style="font-family: 'JetBrains Mono', monospace; font-size: 0.8125rem;">${stat.name}</td><td style="color: #10b981; font-weight: 600;">${stat.success}</td><td style="color: #ef4444; font-weight: 600;">${stat.fail}</td><td class="success-rate ${rateClass}">${stat.successRate}${stat.successRate !== 'N/A' ? '%' : ''}</td><td style="font-family: 'JetBrains Mono', monospace;">${stat.avgTime}${stat.avgTime !== 'N/A' ? 'ms' : ''}</td></tr>`; }).join('') || '<tr><td colspan="5" style="text-align: center; padding: 20px; color: var(--gray-500);">æš‚æ— æ•°æ®</td></tr>';
            modal.classList.add('active');
        }
        function closeSourceStats() { document.getElementById('sourceStatsModal').classList.remove('active'); }
        document.getElementById('sourceStatsModal')?.addEventListener('click', (e) => { if (e.target.id === 'sourceStatsModal') closeSourceStats(); });
        function updateSourceIndicator(sourceName) { lastSuccessfulSource = sourceName; const indicator = document.getElementById('currentSourceName'); if (indicator) indicator.textContent = sourceName; }

        window.addEventListener('DOMContentLoaded', () => { console.log('Higher | 9880699@gmail.com'); initChart(); renderFundList(); fetchMarketIndices(); if (funds.length > 0) selectFund(funds[0]); startAutoUpdate(); });

        function renderFundList() {
            const listEl = document.getElementById('fundList');
            if (funds.length === 0) { listEl.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“Š</div><div class="empty-text">è¿˜æ²¡æœ‰æ·»åŠ åŸºé‡‘</div><div class="empty-subtext">è¾“å…¥åŸºé‡‘ä»£ç å¼€å§‹ç›‘æ§</div></div>`; return; }
            listEl.innerHTML = funds.map(fund => {
                const isCollapsed = fund._cardCollapsed !== false; // é»˜è®¤æŠ˜å 
                const status = getMarketStatus();
                const isRealtime = (status.canRealtimeUpdate || status.reason === 'åˆé—´ä¼‘å¸‚');
                const displayNav = getDisplayNav(fund);
                const badgeVal = getDisplayDayGrowth(fund);
                const badgeOk = Number.isFinite(badgeVal);
                return `
                <div class="fund-item ${selectedFund?.code === fund.code ? 'active' : ''} ${isCollapsed ? 'card-collapsed' : 'card-expanded'}" data-code="${fund.code}">
                    <div class="fund-header" onclick="toggleFundCard('${fund.code}', event)">
                        <div class="fund-info">
                            <div class="fund-name">${fund.name || 'åŠ è½½ä¸­...'}<span class="fund-collapse-arrow ${isCollapsed ? 'collapsed' : ''}" id="arrow_${fund.code}">â–¼</span></div>
                            <div class="fund-code">${fund.code}<span class="fund-code-chg ${badgeOk ? (badgeVal >= 0 ? 'positive' : 'negative') : 'neutral'}">${badgeOk ? (badgeVal >= 0 ? '+' : '') + badgeVal.toFixed(2) + '%' : '--'}</span></div>
                        </div>
                        <div class="fund-actions">
                            <button class="btn-icon btn-edit" onclick="event.stopPropagation(); openPosModal('${fund.code}')" title="ç¼–è¾‘æŒä»“">âœï¸</button>
                            <button class="btn-icon btn-refresh" onclick="event.stopPropagation(); refreshFundByCode('${fund.code}')">ğŸ”„</button>
                            <button class="btn-icon btn-delete" onclick="event.stopPropagation(); deleteFund('${fund.code}')">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                    <div class="fund-body ${isCollapsed ? 'collapsed' : ''}" id="body_${fund.code}">
                        <div class="fund-metrics">
                            <div class="metric-card"><div class="metric-label">ä¼°ç®—å‡€å€¼</div><div class="metric-value">${displayNav}</div></div>
                            <div class="metric-card"><div class="metric-label">æ—¥æ¶¨è·Œ</div><div class="metric-value ${badgeOk && badgeVal >= 0 ? 'positive' : 'negative'}">${badgeOk ? (badgeVal >= 0 ? '+' : '') + badgeVal.toFixed(2) + '%' : '--'}</div></div>
                        </div>
                        <div class="fund-chart" id="miniChart_${fund.code}"></div>
                    </div>
                </div>`;
            }).join('');
            // ç»‘å®šå¡ç‰‡ä¸»åŒºåŸŸç‚¹å‡» â†’ é€‰ä¸­åŸºé‡‘
            listEl.querySelectorAll('.fund-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (e.target.closest('.fund-actions') || e.target.closest('.fund-header')) return;
                    const fund = funds.find(f => f.code === item.dataset.code);
                    if (fund) selectFund(fund);
                });
            });
            funds.forEach(fund => setTimeout(() => initMiniChart(fund), 100));
        }

        function refreshFundByCode(code) {
            const fund = funds.find(f => f.code === code);
            if (!fund) return;
            fetchFundData(fund);
        }

        function toggleFundCard(code, event) {
            event.stopPropagation();
            if (event.target.closest('.fund-actions')) return;
            const fund = funds.find(f => f.code === code);
            if (!fund) return;
            const body = document.getElementById('body_' + code);
            const arrow = document.getElementById('arrow_' + code);
            if (!body) return;
            const wasCollapsed = body.classList.contains('collapsed');
            body.classList.toggle('collapsed');
            if (arrow) arrow.classList.toggle('collapsed');
            fund._cardCollapsed = !wasCollapsed;
            const root = event.currentTarget?.closest('.fund-item');
            if (root) {
                root.classList.toggle('card-collapsed', fund._cardCollapsed !== false);
                root.classList.toggle('card-expanded', fund._cardCollapsed === false);
            }
            // å±•å¼€æ—¶é‡æ–°åˆå§‹åŒ–è¿·ä½ å›¾
            if (wasCollapsed) {
                setTimeout(() => {
                    if (miniCharts[code]) { miniCharts[code].dispose(); delete miniCharts[code]; }
                    initMiniChart(fund);
                }, 50);
            }
            // åŒæ—¶é€‰ä¸­è¯¥åŸºé‡‘
            selectFund(fund);
        }


        function initMiniChart(fund) {
            const chartDom = document.getElementById(`miniChart_${fund.code}`);
            if (!chartDom) return;
            // renderFundList ä¼šé‡å»º DOMï¼šè‹¥ç¼“å­˜å®ä¾‹ç»‘å®šçš„æ˜¯æ—§èŠ‚ç‚¹ï¼Œä¼šå¯¼è‡´â€œç‚¹ä¸€ä¸‹å°±æ¶ˆå¤±/ä¸ä¸€è‡´â€
            const cached = miniCharts[fund.code];
            if (cached) {
                const dom0 = (typeof cached.getDom === 'function') ? cached.getDom() : null;
                if (dom0 && dom0 !== chartDom) {
                    cached.dispose();
                    delete miniCharts[fund.code];
                } else {
                    return;
                }
            }
            const miniChart = echarts.init(chartDom);
            miniCharts[fund.code] = miniChart;
            const { xData, yData } = getRealtimeChartData(fund);
            const isUp = getDisplayDayGrowth(fund) >= 0;
            miniChart.setOption({
                grid: { left: 0, right: 0, top: 5, bottom: 5 },
                xAxis: { type: 'category', data: xData, show: false, boundaryGap: false },
                yAxis: { type: 'value', show: false, scale: true },
                series: [{ type: 'line', data: yData, smooth: true, symbol: 'none', lineStyle: { width: 2, color: isUp ? '#ef4444' : '#10b981' }, areaStyle: { color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{ offset: 0, color: isUp ? 'rgba(239, 68, 68, 0.3)' : 'rgba(16, 185, 129, 0.3)' }, { offset: 1, color: 'rgba(255,255,255,0)' }]) } }]
            });
            window.addEventListener('resize', () => miniChart.resize());
        }

        function updateMiniChart(fund) {
            const chartDom = document.getElementById(`miniChart_${fund.code}`);
            if (!chartDom) return;
            const c = miniCharts[fund.code];
            if (!c) { initMiniChart(fund); return; }
            const dom0 = (typeof c.getDom === 'function') ? c.getDom() : null;
            if (dom0 && dom0 !== chartDom) {
                c.dispose();
                delete miniCharts[fund.code];
                initMiniChart(fund);
                return;
            }
            const { xData, yData } = getRealtimeChartData(fund);
            const isUp = getDisplayDayGrowth(fund) >= 0;
            c.setOption({
                xAxis: { data: xData },
                series: [{
                    data: yData,
                    lineStyle: { width: 2, color: isUp ? '#ef4444' : '#10b981' },
                    areaStyle: { color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{ offset: 0, color: isUp ? 'rgba(239, 68, 68, 0.3)' : 'rgba(16, 185, 129, 0.3)' }, { offset: 1, color: 'rgba(255,255,255,0)' }]) }
                }]
            }, { lazyUpdate: true });
        }

        function getMiniRealtimeSeries(fund) {
            const series = getRealtimeSeriesForChart(fund);
            let end = getEffectiveRealtimeEndIndex(series);
            if (end < 0) end = series.length - 1;
            return series.slice(0, end + 1);
        }

        function findLastFiniteIndex(arr) {
            if (!Array.isArray(arr)) return -1;
            for (let i = arr.length - 1; i >= 0; i--) {
                if (Number.isFinite(arr[i])) return i;
            }
            return -1;
        }

        function getEffectiveRealtimeEndIndex(series) {
            const timeEnd = getRealtimeEndIndex();
            const lastKnown = findLastFiniteIndex(series);
            if (timeEnd < 0) return lastKnown;
            if (lastKnown < 0) return timeEnd;
            return Math.min(timeEnd, lastKnown);
        }

        function getRealtimeSeriesForChart(fund) {
            const baseValue = parseFloat(fund.estimatedNav || fund.currentNav || 1.5);
            const stable = Number.isFinite(baseValue) ? baseValue : 1.5;
            const raw = Array.isArray(fund.realtimeHistory) ? fund.realtimeHistory : [];
            const out = new Array(242);
            let last = stable;
            // ä¸è¦æŠŠâ€œæœªæ¥æ—¶é—´æ®µâ€ç”¨ last å€¼ç¡¬å¡«æ»¡ï¼Œå¦åˆ™åˆä¼‘/ç›˜å‰ä¼šçœ‹èµ·æ¥åƒç”»åˆ°äº† 15:00ã€‚
            // æœªæ¥éƒ¨åˆ†ç”¨ nullï¼Œè®©æŠ˜çº¿åœ¨æœ€åä¸€ä¸ªå·²çŸ¥ç‚¹å¤„è‡ªç„¶åœæ­¢ã€‚
            let lastKnown = -1;
            for (let i = raw.length - 1; i >= 0; i--) {
                if (Number.isFinite(raw[i])) { lastKnown = i; break; }
            }
            for (let i = 0; i < 242; i++) {
                const v = raw[i];
                if (Number.isFinite(v)) last = v;
                out[i] = (lastKnown >= 0 && i <= lastKnown) ? last : null;
            }
            return out;
        }

        function getOfficialDayGrowthFromHistory(fund) {
            const raw = historyCache[fund.code];
            if (!Array.isArray(raw) || raw.length < 2) return NaN;
            const a = raw[raw.length - 2]?.y;
            const b = raw[raw.length - 1]?.y;
            if (!Number.isFinite(a) || !Number.isFinite(b) || a === 0) return NaN;
            return ((b - a) / a) * 100;
        }

        function getDisplayDayGrowth(fund) {
            const status = getMarketStatus();
            const sh = getShanghaiTimeParts();
            const todayStr = `${sh.year}-${String(sh.month).padStart(2,'0')}-${String(sh.day).padStart(2,'0')}`;
            const navDateStr = getDateStr(fund.navDate);
            const estDateStr = getDateStr(fund.estimatedTime);
            const est = parseFloat((fund._fundgzDayGrowth !== undefined && fund._fundgzDayGrowth !== null) ? fund._fundgzDayGrowth : fund.dayGrowth);
            const hasTodayEst = (estDateStr === todayStr) && Number.isFinite(est);

            // å¤œé—´å®˜æ–¹å‡€å€¼å·²æ›´æ–°ï¼šä¼˜å…ˆå®˜æ–¹å£å¾„ï¼ˆé¿å…ç»§ç»­æ˜¾ç¤ºâ€œä»Šæ—¥ä¼°ç®—â€é€ æˆè¯¯è§£ï¼‰
            if (navDateStr === todayStr) {
                const off0 = getOfficialDayGrowthFromHistory(fund);
                if (Number.isFinite(off0)) return off0;
            }

            // ä»Šæ—¥å®˜æ–¹å‡€å€¼æœªå‡ºï¼šä¼˜å…ˆå±•ç¤ºâ€œä»Šæ—¥ä¼°ç®—æ¶¨è·Œå¹…â€ï¼ˆç›˜åç‚¹å‡»å¡ç‰‡ä¹Ÿä¸å›é€€åˆ°æ˜¨å¤©ï¼‰
            if (navDateStr !== todayStr && hasTodayEst) {
                return est;
            }

            // äº¤æ˜“ä¸­/åˆä¼‘/ç›˜åè¡¥å…¨ï¼šå±•ç¤ºä¼°ç®—æ—¥æ¶¨è·Œ
            if (status.canRealtimeUpdate || status.reason === 'åˆé—´ä¼‘å¸‚' || status.reason === 'ç›˜åè¡¥å…¨') {
                const v = parseFloat(fund.dayGrowth);
                return Number.isFinite(v) ? v : 0;
            }
            // å…¶ä»–ï¼šæ˜¾ç¤ºå®˜æ–¹æ—¥æ¶¨è·Œï¼ˆå†å²å‡€å€¼è®¡ç®—ï¼‰
            const off = getOfficialDayGrowthFromHistory(fund);
            if (Number.isFinite(off)) return off;
            const fallback = parseFloat(fund.dayGrowth);
            return Number.isFinite(fallback) ? fallback : 0;
        }

        function getDisplayNav(fund) {
            const status = getMarketStatus();
            const sh = getShanghaiTimeParts();
            const todayStr = `${sh.year}-${String(sh.month).padStart(2,'0')}-${String(sh.day).padStart(2,'0')}`;
            const navDateStr = getDateStr(fund.navDate);
            const estDateStr = getDateStr(fund.estimatedTime);
            const estNavNum = parseFloat(fund.estimatedNav);
            const hasTodayEst = (estDateStr === todayStr) && Number.isFinite(estNavNum) && estNavNum > 0;

            // ä»Šæ—¥å®˜æ–¹å‡€å€¼æœªå‡ºï¼šä¼˜å…ˆå±•ç¤ºâ€œä»Šæ—¥æœ€åä¸€æ¬¡ä¼°ç®—å€¼â€ï¼ˆç›˜åä¹Ÿè¦ä¿ç•™ï¼‰
            if (navDateStr !== todayStr && hasTodayEst) {
                return fund.estimatedNav;
            }

            // äº¤æ˜“ä¸­/åˆä¼‘/ç›˜åè¡¥å…¨ï¼šå±•ç¤ºä¼°ç®—å‡€å€¼ï¼ˆè‹¥æœ‰ï¼‰ï¼Œå¦åˆ™å›é€€å®˜æ–¹å‡€å€¼
            if (status.canRealtimeUpdate || status.reason === 'åˆé—´ä¼‘å¸‚' || status.reason === 'ç›˜åè¡¥å…¨') {
                return fund.estimatedNav || fund.currentNav || '--';
            }
            return fund.currentNav || '--';
        }

        function getShanghaiTimeParts() {
            const now = new Date();
            const parts = new Intl.DateTimeFormat('en-GB', { timeZone: 'Asia/Shanghai', hour12: false, year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' }).formatToParts(now);
            const map = {}; parts.forEach(p => map[p.type] = p.value);
            const dow = new Date(Date.UTC(map.year, map.month - 1, map.day)).getUTCDay();
            return { year: parseInt(map.year), month: parseInt(map.month), day: parseInt(map.day), hour: parseInt(map.hour), minute: parseInt(map.minute), dow };
        }

        function formatLastGzTimeForAshare(gztime) {
            if (!gztime || typeof gztime !== 'string') return gztime;
            let m = gztime.match(/^(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})\s+(\d{1,2}):(\d{2})/);
            if (!m) return gztime;
            const minutes = parseInt(m[4]) * 60 + parseInt(m[5]);
            const date = `${m[1]}-${m[2].padStart(2, '0')}-${m[3].padStart(2, '0')}`;
            return minutes > 15 * 60 ? `${date} 15:00` : `${date} ${m[4].padStart(2,'0')}:${m[5].padStart(2,'0')}`;
        }

        function getDateStr(dateTimeStr) {
            if(!dateTimeStr) return '';
            const m = dateTimeStr.match(/^(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})/);
            if(!m) return '';
            return `${m[1]}-${m[2].padStart(2,'0')}-${m[3].padStart(2,'0')}`;
        }

        function getGzDelayMinutes(gztime) {
            if (!gztime || typeof gztime !== 'string') return null;
            const m = gztime.match(/^(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})\s+(\d{1,2}):(\d{2})/);
            if (!m) return null;
            const gzDate = `${m[1]}-${String(m[2]).padStart(2,'0')}-${String(m[3]).padStart(2,'0')}`;
            const sh = getShanghaiTimeParts();
            const todayStr = `${sh.year}-${String(sh.month).padStart(2,'0')}-${String(sh.day).padStart(2,'0')}`;
            if (gzDate !== todayStr) return null;
            const gzMin = parseInt(m[4]) * 60 + parseInt(m[5]);
            const nowMinRaw = sh.hour * 60 + sh.minute;
            // æ”¶ç›˜åï¼šç”¨ 15:00 ä½œä¸ºâ€œå½“å‰æ—¶é—´â€å°é¡¶ï¼Œé¿å…å»¶è¿Ÿåˆ†é’Ÿæ•°ç»§ç»­å¢é•¿é€ æˆè¯¯è§£
            const nowMin = Math.min(nowMinRaw, 900);
            const gzMinCapped = Math.min(gzMin, 900);
            const d = nowMin - gzMinCapped;
            if (!Number.isFinite(d) || d < 0) return null;
            return d;
        }

        async function fetchFundData(fund, options = {}) {
            try {
                const data = await (fundgzQueue = fundgzQueue.then(() => fetchWithFallback(fund.code)));
                fund.name = data.name;
                fund.currentNav = data.dwjz;
                // ç»Ÿä¸€å£å¾„ï¼šfund.dayGrowth ä»£è¡¨â€œä¼°ç®—æ—¥æ¶¨è·Œå¹…â€ï¼ˆäº¤æ˜“ä¸­ï¼‰ï¼Œæ¥æºå¯èƒ½æ˜¯ fundgz æˆ–æŒä»“ä¼°ç®—
                // é˜²å›é€€ï¼šå¦‚æœæ¥å£è¿”å›äº†æ›´æ—©çš„ gztimeï¼ˆæ—§æ•°æ®ï¼‰ï¼Œä¸è¦è¦†ç›–æœ€æ–°æ˜¾ç¤ºä¸æ›²çº¿
                const gzIdx = getRealtimeMinuteIndexFromGzTime(data.gztime);
                const lastIdx = Number.isFinite(fund._lastGzIdx) ? fund._lastGzIdx : -1;
                const acceptGz = (gzIdx < 0) ? true : (gzIdx >= lastIdx);
                if (acceptGz && gzIdx >= 0) fund._lastGzIdx = gzIdx;

                if (acceptGz) {
                    fund._fundgzDayGrowth = data.gszzl;
                    // é»˜è®¤å…ˆç”¨ fundgzï¼›è‹¥åç»­æœ‰æŒä»“ä¼°ç®—ï¼Œä¼šåœ¨ updateDayGrowthDisplay ä¸­è¦†ç›–
                    fund.dayGrowth = data.gszzl;
                    fund.estimatedNav = data.gsz;
                    fund.estimatedTime = data.gztime;
                }
                fund.navDate = data.jzrq;
                const status = getMarketStatus();
                const seed = parseFloat(status.canRealtimeUpdate ? (data.gsz || data.dwjz) : data.dwjz);
                if (!Array.isArray(fund.realtimeHistory)) fund.realtimeHistory = [];
                if (status.canRealtimeUpdate && acceptGz) {
                    const v0 = parseFloat(data.gsz);
                    const v = (Number.isFinite(v0) && v0 > 0) ? v0 : seed;
                    if (Number.isFinite(v) && v > 0) {
                        // å¯¹é½åˆ°â€œåˆ†é’Ÿæ§½ä½â€ï¼Œé¿å… push å¯¼è‡´æ—¶é—´è½´æ¼‚ç§»åˆ° 14:53 ä¹‹ç±»
                        // ä½¿ç”¨ gztime è®¡ç®—æ§½ä½ï¼Œé¿å…â€œæ›´æ–°äº13:51ä½†å›¾ç”»åˆ°13:55â€è¿™ç§è¶…å‰
                        const idx = gzIdx >= 0 ? gzIdx : getRealtimeMinuteIndex();
                        if (idx >= 0) {
                            if (fund.realtimeHistory.length < 242) fund.realtimeHistory.length = 242;
                            fund.realtimeHistory[idx] = v;
                        }
                    }
                }
                if (acceptGz) {
                    fund.lastUpdateTime = formatLastGzTimeForAshare(data.gztime) || '';
                }
                saveFunds();
                if (!options.suppressRender) renderFundList();
                // åŒæ­¥è¿·ä½ å›¾ä¸ä¸»å›¾ï¼ˆåŒä¸€ä»½ realtimeHistoryï¼‰
                updateMiniChart(fund);
                if (selectedFund?.code === fund.code) { updateMainDisplay(fund); if (currentTimeRange === 'realtime') updateRealtimeChart(); }
            } catch (e) { console.error('è·å–åŸºé‡‘æ•°æ®å¤±è´¥:', e); showToast('æ•°æ®è·å–å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error'); }
        }

        function getShanghaiTimeParts() {
            const now = new Date();
            const parts = new Intl.DateTimeFormat('en-GB', { timeZone: 'Asia/Shanghai', hour12: false, year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' }).formatToParts(now);
            const map = {}; parts.forEach(p => map[p.type] = p.value);
            const dow = new Date(Date.UTC(map.year, map.month - 1, map.day)).getUTCDay();
            return { year: parseInt(map.year), month: parseInt(map.month), day: parseInt(map.day), hour: parseInt(map.hour), minute: parseInt(map.minute), dow };
        }

        function formatLastGzTimeForAshare(gztime) {
            if (!gztime || typeof gztime !== 'string') return gztime;
            let m = gztime.match(/^(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})\s+(\d{1,2}):(\d{2})/);
            if (!m) return gztime;
            const minutes = parseInt(m[4]) * 60 + parseInt(m[5]);
            const date = `${m[1]}-${m[2].padStart(2, '0')}-${m[3].padStart(2, '0')}`;
            return minutes > 15 * 60 ? `${date} 15:00` : `${date} ${m[4].padStart(2,'0')}:${m[5].padStart(2,'0')}`;
        }

        function getDateStr(dateTimeStr) {
            if(!dateTimeStr) return '';
            const m = dateTimeStr.match(/^(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})/);
            if(!m) return '';
            return `${m[1]}-${m[2].padStart(2,'0')}-${m[3].padStart(2,'0')}`;
        }

        function updateMainDisplay(fund) {
            document.getElementById('selectedFundName').textContent = fund.name || 'æœªçŸ¥åŸºé‡‘';
            document.getElementById('selectedFundCode').textContent = fund.code;
            document.getElementById('currentNav').textContent = fund.currentNav || '--';
            document.getElementById('navDateLabel').textContent = fund.navDate ? fund.navDate.substring(5) : '--';

            const sh0 = getShanghaiTimeParts();
            const todayStr0 = `${sh0.year}-${String(sh0.month).padStart(2,'0')}-${String(sh0.day).padStart(2,'0')}`;
            const navDateStr0 = getDateStr(fund.navDate);
            const navChangeEl = document.getElementById('navChange');
            if (navChangeEl) {
                if (navDateStr0 === todayStr0) {
                    const raw = historyCache[fund.code];
                    const prev = Array.isArray(raw) && raw.length >= 2 ? raw[raw.length - 2] : null;
                    const prevNav = prev ? Number(prev.y) : NaN;
                    const prevDate = prev ? tsToDateStr(prev.x) : '';
                    if (Number.isFinite(prevNav)) {
                        navChangeEl.textContent = `å‰æ—¥å‡€å€¼ ${prevNav.toFixed(4)}${prevDate ? `ï¼ˆ${prevDate.slice(5)}ï¼‰` : ''}`;
                        navChangeEl.className = 'stat-change';
                    } else {
                        navChangeEl.textContent = 'å‰æ—¥å‡€å€¼ --';
                        navChangeEl.className = 'stat-change';
                    }
                } else if (navDateStr0) {
                    navChangeEl.textContent = `æœ€è¿‘æŠ«éœ² ${navDateStr0.slice(5)} 15:00`;
                    navChangeEl.className = 'stat-change';
                } else {
                    navChangeEl.textContent = 'ç­‰å¾…å‡€å€¼æ›´æ–°';
                    navChangeEl.className = 'stat-change';
                }
            }

            // æ—¥æ¶¨è·Œå¹… â€” ç”± updateDayGrowthDisplay è´Ÿè´£æ¸²æŸ“
            updateDayGrowthDisplay(fund);
            
            const status = getMarketStatus();
            // æŒä»“æ”¶ç›Šï¼šä»Šæ—¥å®˜æ–¹æœªå‡ºä½†æœ‰ä¼°ç®—æ—¶ï¼ˆç›˜åä¹Ÿå¯èƒ½ï¼‰ï¼Œä¼˜å…ˆç”¨ä¼°ç®—å‡€å€¼å‚ä¸è®¡ç®—ï¼Œé¿å…æ˜¾ç¤ºä¸º 0
            const profitNav0 = parseFloat(getDisplayNav(fund));
            const profitNav = Number.isFinite(profitNav0)
                ? profitNav0
                : ((status.canRealtimeUpdate || status.reason === 'åˆé—´ä¼‘å¸‚' || status.reason === 'ç›˜åè¡¥å…¨')
                    ? parseFloat(fund.estimatedNav || fund.currentNav)
                    : parseFloat(fund.currentNav));
            if (fund.holdingCost && fund.holdingShares && Number.isFinite(profitNav)) {
                const profit = (profitNav - fund.holdingCost) * fund.holdingShares;
                const pp = ((profitNav - fund.holdingCost) / fund.holdingCost * 100);
                document.getElementById('totalProfit').textContent = 'Â¥' + profit.toFixed(2);
                // æ³¨æ„ï¼šæœ¬é¡¹ç›® CSS å®šä¹‰ positive=çº¢ã€negative=ç»¿ï¼ˆæ¶¨çº¢è·Œç»¿ï¼‰
                document.getElementById('totalProfit').className = `stat-value ${profit>=0?'positive':'negative'}`;
                const ppEl = document.getElementById('profitPercent');
                ppEl.textContent = (profit>=0?'+':'') + pp.toFixed(2) + '%';
                ppEl.className = `stat-change ${profit>=0?'positive':'negative'}`;
                ppEl.style.color = '';
            } else {
                document.getElementById('totalProfit').textContent = '--';
                document.getElementById('totalProfit').className = 'stat-value';
                const ppEl = document.getElementById('profitPercent');
                ppEl.textContent = 'æœªè®¾ç½®æŒä»“';
                ppEl.className = 'stat-change';
                ppEl.style.color = '#000';
            }

            // ç”¨ä¸Šæµ·æ—¶åŒºåˆ¤æ–­å‘¨æœ«
            const sh = getShanghaiTimeParts();
            const isWeekend = (sh.dow === 0 || sh.dow === 6);
            if (isWeekend) {
                document.getElementById('estimatedNav').textContent = '--';
                document.getElementById('estimatedChange').textContent = 'å‘¨æœ«ä¼‘å¸‚';
                document.getElementById('estimatedChange').className = 'stat-change';
                document.getElementById('estLabel').textContent = 'ä¼°ç®—å‡€å€¼';
            } else {
                const navDateStr = getDateStr(fund.navDate);
                // ä»Šæ—¥æ—¥æœŸï¼ˆä¸Šæµ·ï¼‰
                const todayStr = `${sh.year}-${String(sh.month).padStart(2,'0')}-${String(sh.day).padStart(2,'0')}`;

                // ä»Šæ—¥å·²å‡ºå®˜æ–¹å‡€å€¼ï¼šä¸å†å±•ç¤ºä¼°ç®—ï¼ˆé¿å…è¯¯è§£ï¼‰ï¼Œä½†ä¿ç•™â€œä¼°ç®—å‡€å€¼â€æ ‡ç­¾
                if (navDateStr === todayStr) {
                    document.getElementById('estimatedNav').textContent = fund.currentNav || '--';
                    document.getElementById('estimatedChange').textContent = 'å·²æ›´æ–°ä»Šæ—¥å‡€å€¼';
                    document.getElementById('estimatedChange').className = 'stat-change';
                    document.getElementById('estLabel').textContent = 'ä¼°ç®—å‡€å€¼';
                } else {
                    // ä»Šæ—¥å°šæœªå‡ºå®˜æ–¹å‡€å€¼ï¼šç›˜åä¹Ÿå±•ç¤ºâ€œä»Šæ—¥æœ€åä¸€æ¬¡ä¼°ç®—å€¼â€
                    const estDateStr = getDateStr(fund.estimatedTime);
                    const estNavNum = parseFloat(fund.estimatedNav);
                    const hasTodayEst = (estDateStr === todayStr) && Number.isFinite(estNavNum) && estNavNum > 0;

                    if (hasTodayEst) {
                        const estChgNum = parseFloat((fund._fundgzDayGrowth !== undefined && fund._fundgzDayGrowth !== null) ? fund._fundgzDayGrowth : fund.dayGrowth);
                        document.getElementById('estimatedNav').textContent = estNavNum.toFixed(4);
                        document.getElementById('estimatedChange').textContent = Number.isFinite(estChgNum)
                            ? ((estChgNum >= 0 ? '+' : '') + estChgNum.toFixed(2) + '%')
                            : '--';
                        document.getElementById('estimatedChange').className = `stat-change ${Number.isFinite(estChgNum) && estChgNum >= 0 ? 'positive' : 'negative'}`;
                        document.getElementById('estLabel').textContent = 'ä¼°ç®—å‡€å€¼';
                    } else {
                        document.getElementById('estimatedNav').textContent = '--';
                        document.getElementById('estimatedChange').textContent = 'ç­‰å¾…ä»Šæ—¥ä¼°å€¼æ›´æ–°';
                        document.getElementById('estimatedChange').className = 'stat-change';
                        document.getElementById('estLabel').textContent = 'ä¼°ç®—å‡€å€¼';
                    }
                }
            }
            const delayMin = getGzDelayMinutes(fund.estimatedTime);
            const sh2 = getShanghaiTimeParts();
            const todayStr2 = `${sh2.year}-${String(sh2.month).padStart(2,'0')}-${String(sh2.day).padStart(2,'0')}`;
            const navDateStr2 = getDateStr(fund.navDate);
            let showUpdateTime = fund.lastUpdateTime || '--';
            let useDelay = true;
            // è‹¥ä»Šæ—¥å®˜æ–¹å‡€å€¼å·²å‡ºï¼Œä½†ä¼°å€¼æº(gztime)æ»ååˆ°æ—§æ—¥æœŸï¼Œé¿å…â€œæ›´æ–°äº 01-30â€è¿™ç§è¯¯å¯¼
            if (navDateStr2 === todayStr2) {
                const lastDateStr = getDateStr(showUpdateTime);
                if (lastDateStr && lastDateStr !== todayStr2) {
                    showUpdateTime = `${todayStr2} 15:00`;
                    useDelay = false;
                }
            }
            const delayText = (useDelay && Number.isFinite(delayMin) && delayMin >= 2) ? `ï¼ˆå»¶è¿Ÿ${delayMin}åˆ†é’Ÿï¼‰` : '';
            document.getElementById('updateTime').textContent = 'æ›´æ–°äº ' + showUpdateTime + delayText;
            updateMarketStatusUI();
        }

        // ============================================================
        // æ—¥æ¶¨è·Œå¹…æ¸²æŸ“ â€” å¼€ç›˜ä¸­ç”¨æŒä»“åŠ æƒä¼°ç®—ï¼Œæœªå¼€ç›˜ç”¨å®˜æ–¹æ•°æ®
        // ============================================================
        function updateDayGrowthDisplay(fund) {
            const el = document.getElementById('dayGrowth');
            const chgEl = document.getElementById('dayGrowthChange');
            const status = getMarketStatus();
            const cache = holdingsCache[fund.code];

            const sh = getShanghaiTimeParts();
            const todayStr = `${sh.year}-${String(sh.month).padStart(2,'0')}-${String(sh.day).padStart(2,'0')}`;
            const navDateStr = getDateStr(fund.navDate);
            const estDateStr = getDateStr(fund.estimatedTime);
            const fundgzEst = parseFloat((fund._fundgzDayGrowth !== undefined && fund._fundgzDayGrowth !== null) ? fund._fundgzDayGrowth : fund.dayGrowth);
            const hasFundgzToday = (estDateStr === todayStr) && Number.isFinite(fundgzEst);

            // å¤œé—´å®˜æ–¹å‡€å€¼å·²æ›´æ–°ï¼šå¼ºåˆ¶å±•ç¤ºå®˜æ–¹å£å¾„ï¼ˆå¹¶æ ‡æ³¨æ—¥æœŸæ—¶é—´ï¼‰
            if (navDateStr === todayStr) {
                const off = getOfficialDayGrowthFromHistory(fund);
                if (Number.isFinite(off)) {
                    if (Number.isFinite(off)) fund.dayGrowth = off;
                    el.innerHTML = (off >= 0 ? '+' : '') + off.toFixed(2) + '%';
                    el.className = `stat-value ${off >= 0 ? 'positive' : 'negative'}`;
                    if (chgEl) {
                        const offDate = navDateStr ? navDateStr.slice(5) : '';
                        chgEl.innerHTML = `æœ€æ–°å‡€å€¼å˜åŠ¨${offDate ? ' ' + offDate + ' 15:00' : ''} <span class="day-growth-source official">å®˜æ–¹</span>`;
                    }
                    return;
                }
            }

            // ä½¿ç”¨ä¼°ç®—æ¡ä»¶:
            //   å¸‚åœºæ­£åœ¨äº¤æ˜“ æˆ– åˆé—´ä¼‘å¸‚ï¼ˆä¸Šåˆå·²æœ‰æ•°æ®ï¼‰
            //   ä¸” holdingsCache ä¸­æœ‰æ–°é²œæ•°æ®ï¼ˆ< 5åˆ†é’Ÿï¼‰
            const cacheAge = cache ? (Date.now() - cache.timestamp) : Infinity;
            const useHoldingsEstimation = (status.canRealtimeUpdate || status.reason === 'åˆé—´ä¼‘å¸‚') 
                                          && cache 
                                          && cacheAge < 300000;
            const useEstimation = useHoldingsEstimation || (navDateStr !== todayStr && hasFundgzToday);

            if (useEstimation) {
                if (useHoldingsEstimation) {
                    const est = cache.estDayChg;
                    if (Number.isFinite(est)) fund.dayGrowth = est;
                    el.innerHTML = (est >= 0 ? '+' : '') + est.toFixed(2) + '%';
                    el.className = `stat-value ${est >= 0 ? 'positive' : 'negative'}`;
                    if (chgEl) {
                        chgEl.innerHTML = `TOP10æƒé‡ ${cache.top10Weight.toFixed(2)}% <span class="day-growth-source est">ä¼°ç®—</span>`;
                    }
                } else {
                    const est = fundgzEst;
                    if (Number.isFinite(est)) fund.dayGrowth = est;
                    el.innerHTML = (est >= 0 ? '+' : '') + est.toFixed(2) + '%';
                    el.className = `stat-value ${est >= 0 ? 'positive' : 'negative'}`;
                    if (chgEl) {
                        const t = (fund.estimatedTime && typeof fund.estimatedTime === 'string') ? (fund.estimatedTime.match(/\b\d{1,2}:\d{2}\b/)?.[0] || '') : '';
                        chgEl.innerHTML = `ä»Šæ—¥ä¼°ç®—${t ? ' ' + t : ''} <span class="day-growth-source est">ä¼°ç®—</span>`;
                    }
                }
            } else {
                // â”€â”€ æœªå¼€ç›˜ / ç¼“å­˜è¿‡æœŸ: æ˜¾ç¤ºå®˜æ–¹æ—¥æ¶¨è·Œï¼ˆå†å²å‡€å€¼å£å¾„ï¼‰ â”€â”€
                const dg = getDisplayDayGrowth(fund);
                // éäº¤æ˜“æ—¶ä¹Ÿä¿æŒ dayGrowth ä¸å±•ç¤ºä¸€è‡´ï¼ˆé¿å…å·¦ä¾§/å³ä¾§ä¸åŒæ­¥ï¼‰
                if (Number.isFinite(dg)) fund.dayGrowth = dg;
                el.innerHTML = !isNaN(dg) ? (dg >= 0 ? '+' : '') + dg.toFixed(2) + '%' : '--';
                el.className = `stat-value ${!isNaN(dg) && dg >= 0 ? 'positive' : 'negative'}`;
                if (chgEl) {
                    const offDate = navDateStr ? navDateStr.slice(5) : '';
                    chgEl.innerHTML = !isNaN(dg)
                        ? `æœ€æ–°å‡€å€¼å˜åŠ¨${offDate ? ' ' + offDate + ' 15:00' : ''} <span class="day-growth-source official">å®˜æ–¹</span>`
                        : '--';
                }
            }
        }

        function getRealtimeMinuteIndex() {
            const t = getShanghaiTimeParts();
            const min = t.hour * 60 + t.minute;
            if (min < 570) return -1;
            if (min <= 690) return min - 570;
            if (min < 780) return -1;
            if (min <= 900) return 121 + (min - 780);
            return -1;
        }

        function getRealtimeMinuteIndexFromGzTime(gztime) {
            if (!gztime || typeof gztime !== 'string') return -1;
            const m = gztime.match(/\b(\d{1,2}):(\d{2})\b/);
            if (!m) return -1;
            const hour = parseInt(m[1]);
            const minute = parseInt(m[2]);
            if (!Number.isFinite(hour) || !Number.isFinite(minute)) return -1;
            const min = hour * 60 + minute;
            if (min < 570) return -1;
            if (min <= 690) return min - 570;
            if (min < 780) return -1;
            if (min <= 900) return 121 + (min - 780);
            return -1;
        }

        function getRealtimeEndIndex() {
            const t = getShanghaiTimeParts();
            const min = t.hour * 60 + t.minute;
            if (t.dow === 0 || t.dow === 6) return -1;
            // ç›˜å‰
            if (min < 570) return -1;
            // ä¸Šåˆ 09:30 - 11:30
            if (min <= 690) return min - 570;
            // åˆä¼‘ï¼šå›ºå®šåˆ° 11:30
            if (min < 780) return 120;
            // ä¸‹åˆ 13:00 - 15:00
            if (min <= 900) return 121 + (min - 780);
            // ç›˜åï¼šå›ºå®šåˆ° 15:00
            return 241;
        }

        function updateMarketStatusUI() {
            const s = getMarketStatus();
            const el = document.getElementById('marketStatus');
            el.className = `market-status ${s.isOpen?'open':'closed'}`;
            const displayReason = (s.reason === 'ç›˜åè¡¥å…¨') ? 'ç›˜å' : s.reason;
            el.innerHTML = `<span>${s.isOpen?'â–¶':'â¸'}</span><span>${s.isOpen?'äº¤æ˜“ä¸­':displayReason}</span>`;
        }

        function getMarketStatus() {
            const t = getShanghaiTimeParts();
            const min = t.hour * 60 + t.minute;
            if (t.dow === 0 || t.dow === 6) return { isOpen: false, reason: 'å‘¨æœ«ä¼‘å¸‚', canRealtimeUpdate: false };
            if ((min >= 570 && min < 690) || (min >= 780 && min < 900)) return { isOpen: true, reason: 'äº¤æ˜“ä¸­', canRealtimeUpdate: true };
            // ç›˜åè¡¥å…¨æœŸï¼š15:00 åæ•°æ®æºå¯èƒ½ä»åœ¨è¡¥æœ€åå‡ åˆ†é’Ÿï¼ˆä¾‹å¦‚ 14:55 æ‰åˆ°ï¼‰ï¼Œå…è®¸çŸ­æ—¶é—´ç»§ç»­æ‹‰å–ä¼°å€¼
            if (min >= 900 && min < 915) return { isOpen: false, reason: 'ç›˜åè¡¥å…¨', canRealtimeUpdate: true };
            return { isOpen: false, reason: min < 570 ? 'ç›˜å‰' : (min >= 900 ? 'ç›˜å' : 'åˆé—´ä¼‘å¸‚'), canRealtimeUpdate: false };
        }

        function saveFunds() { localStorage.setItem('funds', JSON.stringify(funds)); }
        
        async function addFund() {
            const code = document.getElementById('fundCode').value.trim();
            if (!/^\d{6}$/.test(code)) return showToast('è¯·è¾“å…¥6ä½æ•°å­—åŸºé‡‘ä»£ç ', 'error');
            if (funds.some(f => f.code === code)) return showToast('è¯¥åŸºé‡‘å·²å­˜åœ¨', 'error');
            const fund = { code, holdingCost: parseFloat(document.getElementById('holdingCost').value)||null, holdingShares: parseFloat(document.getElementById('holdingShares').value)||null, name: 'åŠ è½½ä¸­...', currentNav: '--', dayGrowth: '--' };
            funds.push(fund); saveFunds(); renderFundList();
            document.getElementById('fundCode').value = ''; document.getElementById('holdingCost').value = ''; document.getElementById('holdingShares').value = '';
            await fetchFundData(fund); showToast('æ·»åŠ æˆåŠŸ');
            if (window.innerWidth <= 768) { mobileMenuBtn.classList.remove('active'); sidebar.classList.remove('open'); sidebarOverlay.classList.remove('active'); }
        }
        
        function deleteFund(code) {
            if (!confirm('ç¡®è®¤åˆ é™¤è¯¥åŸºé‡‘ï¼Ÿ')) return;
            funds = funds.filter(f => f.code !== code); saveFunds();
            if (miniCharts[code]) { miniCharts[code].dispose(); delete miniCharts[code]; }
            if (selectedFund?.code === code) selectedFund = funds[0] || null;
            renderFundList(); if(selectedFund) selectFund(selectedFund);
        }

        function selectFund(fund) {
            selectedFund = fund; renderFundList(); updateMainDisplay(fund); loadHoldingsAndSectors(fund);
            fetchHistoryData(fund.code, currentTimeRange !== 'realtime');
            if (currentTimeRange === 'realtime') { updateRealtimeChart(); startRealtimeUpdate(); }
            if (window.innerWidth <= 768) { mobileMenuBtn.classList.remove('active'); sidebar.classList.remove('open'); sidebarOverlay.classList.remove('active'); }
        }

        function getSecId(code) {
            if (!code) return "";
            // è¿‡æ»¤æ‰å¯èƒ½å­˜åœ¨çš„å­—æ¯å‰ç¼€ï¼ˆå¦‚ sh601228 æå–ä¸º 601228ï¼‰
            let pureCode = String(code).match(/\d{6}/);
            if (pureCode) {
                return pureCode[0];
            }
            return String(code).trim().substring(0, 6);
        }

        function getEastmoneySecId(code) {
            const c = getSecId(code);
            if (!/^\d{6}$/.test(c)) return c;
            // ä¸Šäº¤æ‰€: 6xxxxx / æ·±äº¤æ‰€&åŒ—äº¤æ‰€ç­‰: 0xxxxx/3xxxxx/8xxxxx...
            return (c.startsWith('6') ? `1.${c}` : `0.${c}`);
        }

        function openStockDetail(code) {
            if (!code) return;
            const stockCode = getSecId(code);
            if (!/^\d{6}$/.test(stockCode)) {
                console.warn("è‚¡ç¥¨ä»£ç æ ¼å¼éæ³•:", stockCode);
                return;
            }
            // æ„å»ºç™¾åº¦å°ç¨‹åºé“¾æ¥
            const url = `https://pqa9p2.smartapps.baidu.com/pages/quote/quote?code=${stockCode}`;
            window.open(url, '_blank', 'noopener,noreferrer');
        }

        // ============================================================
        // æŒä»“åŠ è½½ - å« gushitong.baidu.com æ–°æ•°æ®æºï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
        // ============================================================
        async function loadHoldingsAndSectors(fund, options = {}) {
            const tbody = document.getElementById('holdingsTableBody');
            const tags = document.getElementById('sectorTags');

            // updateOnly: åªæ›´æ–°æ¶¨è·Œå¹…ï¼Œä¸è¦é‡ç»˜ DOMï¼ˆé¿å…é—ªè·³ï¼‰
            if (options.updateOnly) {
                await updateHoldingsChgOnly(fund);
                return;
            }

            // silent: å·²ç»æœ‰å†…å®¹æ—¶ä¸è¦å†™â€œåŠ è½½ä¸­...â€è¦†ç›–é€ æˆé—ªè·³
            if (!options.silent) {
                if (tbody) tbody.innerHTML = `<tr><td colspan="4" style="text-align: center; color: var(--gray-500); padding: 40px;">åŠ è½½ä¸­...</td></tr>`;
                if (tags) tags.innerHTML = `<span style="font-size: 0.8125rem; color: var(--gray-500);">åŠ è½½ä¸­...</span>`;
            }

            // --- æ•°æ®æº1 (ä¼˜å…ˆ): gushitong.baidu.com â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
            // è¿”å›çš„JSONç»“æ„:
            //   Result[0].DisplayData.resultData.tplData.result.content.tabs[0 (æŒä»“tab)]
            //     .content.heavyStock.body[]  â†’ TOP 10 æŒä»“è‚¡ç¥¨
            //     .content.industryPositon.list[] â†’ è¡Œä¸šæ¿å—å æ¯”
            const baiduTargetUrl = `https://gushitong.baidu.com/opendata?resource_id=5803&query=${fund.code}&new_need_di=1&source=qieman`;
            const baiduProxyOff = (localStorage.getItem('BAIDU_PROXY_OFF') || '') === '1';
            const baiduCorsProxy = ((localStorage.getItem('BAIDU_CORS_PROXY') || '').trim() || 'https://api.allorigins.win/get?url=');
            const baiduAllowDirect = (localStorage.getItem('BAIDU_DIRECT') || '') === '1';

            async function fetchBaiduViaProxy(targetUrl, proxyPrefix) {
                const proxyUrl = `${proxyPrefix}${encodeURIComponent(targetUrl)}`;
                const res = await fetch(proxyUrl, { signal: AbortSignal.timeout(12000) });
                if (!res.ok) throw new Error(`proxy http ${res.status}`);
                let payload;
                try {
                    payload = await res.json();
                } catch {
                    const text = await res.text();
                    payload = JSON.parse(text);
                }
                const raw = payload && typeof payload === 'object' && typeof payload.contents === 'string'
                    ? payload.contents
                    : payload;
                if (typeof raw === 'string') return JSON.parse(raw);
                return raw;
            }

            const baiduSources = [];
            // ç›´è¿æ–¹æ¡ˆï¼šè‹¥ç™¾åº¦æ¥å£æ”¯æŒ JSONPï¼ˆcb/callbackï¼‰ï¼Œå¯ç»•è¿‡ CORS ä¸”æ›´å¿«
            // æ³¨æ„ï¼šå¦‚æœæ¥å£ä¸æ”¯æŒ JSONPï¼Œè¿™é‡Œä¼šå¾ˆå¿«è¶…æ—¶å¹¶è‡ªåŠ¨å›é€€åˆ°ä»£ç†/ä¸œè´¢å¤‡ç”¨æº
            baiduSources.push({
                name: 'gushitong_jsonp',
                fetch: async () => {
                    try {
                        return await fetchJsonp(baiduTargetUrl, 'cb', 2500);
                    } catch {
                        return await fetchJsonp(baiduTargetUrl, 'callback', 2500);
                    }
                }
            });
            if (!baiduProxyOff && baiduCorsProxy) {
                baiduSources.push({
                    name: 'gushitong_proxy',
                    fetch: async () => await fetchBaiduViaProxy(baiduTargetUrl, baiduCorsProxy)
                });
            }
            if (baiduAllowDirect) {
                baiduSources.push({
                    name: 'gushitong_direct',
                    fetch: async () => {
                        const res = await fetch(baiduTargetUrl, { signal: AbortSignal.timeout(10000) });
                        return await res.json();
                    }
                });
            }

            let baiduData = null; // è§£æåçš„ç»“æ„åŒ–æ•°æ®: { holdings: [...], sectors: [...] }

            for (const source of baiduSources) {
                try {
                    console.log(`ğŸ”„ [æŒä»“-${source.name}] å°è¯•è·å–...`);
                    const json = await runWithSourceStat(`holdings_${source.name}`, async () => await source.fetch());

                    // æ·±å±‚è§£æè·¯å¾„
                    const result = json?.Result?.[0];
                    const tplData = result?.DisplayData?.resultData?.tplData?.result;
                    const tabs = tplData?.content?.tabs;

                    // tabs[0] æ˜¯ "æŒä»“" tab (type: "position")
                    const positionTab = tabs?.find(t => t.type === 'position') || tabs?.[0];
                    const posContent = positionTab?.content;

                    // heavyStock.body â†’ TOP 10 è‚¡ç¥¨
                    const heavyStockBody = posContent?.heavyStock?.body;
                    // industryPositon.list â†’ è¡Œä¸šæ¿å—
                    const industryList = posContent?.industryPositon?.list;
                    // heavyStock æ›´æ–°æ—¥æœŸ
                    const holdingDate = posContent?.heavyStock?.titleHeader?.[1] || '';

                    if (!heavyStockBody || heavyStockBody.length === 0) {
                        throw new Error('heavyStock.body ä¸ºç©º');
                    }

                    // æ˜ å°„æŒä»“æ•°æ®
                    const holdings = heavyStockBody.map(item => ({
                        name: item.name,                          // è‚¡ç¥¨åç§°
                        code: item.code,                          // è‚¡ç¥¨ä»£ç 
                        ratio: parseFloat(item.positionProportion?.replace('%', '')) || 0  // å å‡€å€¼æ¯”ä¾‹
                    }));

                    // æ˜ å°„è¡Œä¸šæ¿å—æ•°æ®
                    const sectors = (industryList || []).map(item => ({
                        name: item.text,                          // è¡Œä¸šåç§°
                        weight: parseFloat(item.value?.replace('%', '')) || 0  // å æ¯”
                    }));

                    baiduData = { holdings, sectors, holdingDate };
                    console.log(`âœ… [æŒä»“-${source.name}] æˆåŠŸ! æŒä»“${holdings.length}æ¡, æ¿å—${sectors.length}æ¡, æ—¥æœŸ: ${holdingDate}`);
                    break;

                } catch (error) {
                    console.warn(`âŒ [æŒä»“-${source.name}] å¤±è´¥:`, error.message);
                    continue;
                }
            }

            // --- æ•°æ®æº2 (å¤‡ç”¨): eastmoney HTML çˆ¬å– â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
            if (!baiduData) {
                console.log('âš ï¸ Baiduæ•°æ®æºå…¨éƒ¨å¤±è´¥ï¼Œå°è¯•eastmoneyå¤‡ç”¨æº...');
                try {
                    const url = `https://fundf10.eastmoney.com/FundArchivesDatas.aspx?type=jjcc&topline=10&code=${fund.code}&year=&month=&rt=${Date.now()}`;
                    const apidata = await fetchApidataViaScript(url, 'holdings_eastmoney_apidata');
                    const html = (apidata?.content || '').toString().replace(/\\r\\n/g, '').replace(/\\n/g, '').replace(/\\t/g, '').replace(/\\\//g, '/').replace(/\\\"/g, '"');
                    const doc = new DOMParser().parseFromString(html, 'text/html');
                    const tables = Array.from(doc.querySelectorAll('table'));
                    const table = tables.find(t => {
                        const thText = (t.querySelector('thead')?.textContent || t.textContent || '').replace(/\s+/g, '');
                        return thText.includes('è‚¡ç¥¨ä»£ç ') && thText.includes('è‚¡ç¥¨åç§°') && thText.includes('å å‡€å€¼');
                    }) || tables[0];

                    let holdings = [];
                    if (table) {
                        const ths = Array.from(table.querySelectorAll('thead th'));
                        const norm = (s) => (s || '').replace(/\s+/g, '').replace(/\u00a0/g, '');
                        const idxCode = ths.findIndex(th => norm(th.textContent).includes('è‚¡ç¥¨ä»£ç '));
                        const idxName = ths.findIndex(th => norm(th.textContent).includes('è‚¡ç¥¨åç§°'));
                        const idxRatio = ths.findIndex(th => {
                            const t = norm(th.textContent);
                            return t.includes('å å‡€å€¼') || t.includes('å å‡€å€¼æ¯”ä¾‹');
                        });

                        const rows = Array.from(table.querySelectorAll('tbody tr'));
                        holdings = rows.map(tr => {
                            const tds = Array.from(tr.querySelectorAll('td'));
                            if (tds.length === 0) return null;
                            const code = (tds[idxCode]?.textContent || '').trim();
                            const name = (tds[idxName]?.textContent || '').trim();
                            const ratioText = (tds[idxRatio]?.textContent || '').trim();
                            let ratio = 0;
                            const m = ratioText.match(/(\d+(\.\d+)?)/);
                            if (m) ratio = parseFloat(m[1]);
                            return { code, name, ratio };
                        }).filter(x => x && x.code && x.name).slice(0, 10);
                    }

                    if (holdings.length > 0) {
                        baiduData = { holdings, sectors: [], holdingDate: '' };
                        console.log(`âœ… eastmoneyå¤‡ç”¨æºè§£æäº† ${holdings.length} æ¡æŒä»“`);
                    }
                } catch (e) {
                    console.error('è§£æeastmoneyæŒä»“å¤±è´¥:', e);
                }
            }

            // --- æ— æ•°æ®é€€å‡º â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
            if (!baiduData || baiduData.holdings.length === 0) {
                console.error('ğŸ’¥ æ‰€æœ‰æŒä»“æ•°æ®æºå‡å¤±è´¥æˆ–æ— æ•°æ®');
                tbody.innerHTML = `<tr><td colspan="4" style="text-align: center; color: var(--gray-500);">æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</td></tr>`;
                tags.innerHTML = `<span style="font-size: 0.8125rem; color: var(--gray-500);">åŠ è½½å¤±è´¥</span>`;
                return;
            }

            // --- æ¸²æŸ“æ¿å—æ ‡ç­¾ï¼ˆè¡Œä¸šå æ¯”ï¼‰â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
            // å¦‚æœæœ‰Baiduè¡Œä¸šæ•°æ®ç›´æ¥ç”¨ï¼›å¦åˆ™åé¢ä»eastmoneyè‚¡ç¥¨è¡Œæƒ…é‡Œå½’å¹¶
            let sectorSource = 'baidu'; // æ ‡è®°æ•°æ®æ¥æº
            if (baiduData.sectors.length > 0) {
                tags.innerHTML = baiduData.sectors.slice(0, 6).map(s =>
                    `<span class="sector-tag">${s.name} ${s.weight.toFixed(1)}%</span>`
                ).join('');
            } else {
                sectorSource = 'eastmoney'; // åç»­ä»è¡Œæƒ…å½’å¹¶
                tags.innerHTML = `<span style="font-size: 0.8125rem; color: var(--gray-500);">æ¿å—æ•°æ®åŠ è½½ä¸­...</span>`;
            }

            // --- è·å–è‚¡ç¥¨å®æ—¶è¡Œæƒ…ï¼ˆæ¶¨è·Œå¹…ï¼‰â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
            const quoteSources = [
                (secid) => `https://push2.eastmoney.com/api/qt/stock/get?secid=${secid}&fields=f2,f3,f4,f43,f60,f100&ut=fa5fd1943c7b386f172d6893dbfba10b&_=${Date.now()}`
            ];

            console.log('ğŸ“ˆ å¼€å§‹è·å–è‚¡ç¥¨è¡Œæƒ…...');
            const quotes = await Promise.all(baiduData.holdings.map(async h => {
                const secid = getEastmoneySecId(h.code);
                for (const getUrl of quoteSources) {
                    try {
                        let qjson;
                        try {
                            qjson = await runWithSourceStat('quote_stock_get_jsonp', async () => await fetchJsonp(getUrl(secid), 'cb', 8000));
                        } catch {
                            qjson = await runWithSourceStat('quote_stock_get_jsonp_callback', async () => await fetchJsonp(getUrl(secid), 'callback', 8000));
                        }
                        if (qjson?.data) {
                            const d = qjson.data;
                            const last = Number(d.f43 ?? d.f2);
                            const prevClose = Number(d.f60);
                            const chgRaw = d.f3;
                            let chg = (typeof chgRaw === 'number') ? chgRaw : Number(chgRaw);
                            if (!Number.isFinite(chg)) {
                                if (Number.isFinite(last) && Number.isFinite(prevClose) && prevClose !== 0) {
                                    chg = ((last - prevClose) / prevClose) * 100;
                                } else {
                                    chg = 0;
                                }
                            }
                            return { ...h, chg, price: Number.isFinite(last) ? last : 0, industry: d.f100 || 'å…¶ä»–' };
                        }
                    } catch (err) { continue; }
                }
                return { ...h, chg: 0, price: 0, industry: 'å…¶ä»–' };
            }));

            // ç»Ÿä¸€å˜é‡ï¼šTOP10 æƒé‡/å‰åæŒä»“å æ¯”åˆè®¡ç”¨åŒä¸€ä¸ª top10Weightï¼Œé¿å…ä¸¤å¤„å„ç®—å„çš„å¯¼è‡´é”™ä¹±
            const top10Weight = quotes.reduce((sum, h) => sum + (parseFloat(h.ratio) || 0), 0);
            const top10WeightTag = `<span class="sector-tag top10-weight">å‰åæŒä»“å æ¯”åˆè®¡ï¼š${top10Weight.toFixed(2)}%ï¼ˆè‚¡ç¥¨æŒä»“ï¼‰</span>`;
            if (tags) {
                tags.innerHTML = top10WeightTag + tags.innerHTML;
            }

            // --- æ¸²æŸ“æŒä»“è¡¨æ ¼ â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
            let holdingDateLabel = '';
            if (baiduData.holdingDate) {
                holdingDateLabel = ` <span style="font-size:0.7rem;color:var(--gray-500);font-weight:500;">(${baiduData.holdingDate})</span>`;
            }
            document.querySelector('.table-header').innerHTML = `åŸºé‡‘æŒä»“ï¼ˆTOP 10ï¼‰${holdingDateLabel}`;

            // ç¼“å­˜å½“å‰ TOP10 åˆ—è¡¨ï¼Œåç»­ updateHoldingsChgOnly åªæ›´æ–°æ¶¨è·Œå¹…
            fund._topHoldings = quotes.map(h => ({ code: h.code, name: h.name, ratio: h.ratio || 0 }));

            tbody.innerHTML = quotes.map(h => `
                <tr data-code="${h.code}" onclick="openStockDetail('${h.code}')">
                    <td>${h.name}</td>
                    <td style="font-family:'JetBrains Mono',monospace;font-size:0.8125rem;">${h.code}</td>
                    <td><strong>${h.ratio ? h.ratio.toFixed(2) + '%' : '--'}</strong></td>
                    <td class="holding-chg ${h.chg >= 0 ? 'positive' : 'negative'}"><strong>${(h.chg > 0 ? '+' : '') + h.chg.toFixed(2) + '%'}</strong></td>
                </tr>
            `).join('');

            // --- å¦‚æœæ¿å—æ•°æ®æ¥è‡ªeastmoneyï¼Œä»è¡Œæƒ…é‡Œå½’å¹¶è¡Œä¸šä¿¡æ¯ â€”â€”â€”â€”â€”â€”â€”â€”
            if (sectorSource === 'eastmoney') {
                const sectors = {};
                quotes.forEach(h => {
                    const ind = h.industry || 'å…¶ä»–';
                    if (!sectors[ind]) sectors[ind] = { name: ind, weight: 0, chg: [] };
                    sectors[ind].weight += (h.ratio || 0);
                    if (h.chg !== undefined) sectors[ind].chg.push(h.chg);
                });
                const sortedSectors = Object.values(sectors).map(s => ({ ...s, avgChg: s.chg.length > 0 ? s.chg.reduce((a, b) => a + b, 0) / s.chg.length : 0 })).sort((a, b) => b.weight - a.weight).slice(0, 6);
                const filteredSectors = sortedSectors.filter(s => s.name !== 'å…¶ä»–');
                const sectorHtml = filteredSectors.map(s =>
                    `<span class="sector-tag ${s.avgChg >= 0 ? 'positive' : 'negative'}">${s.name} ${s.weight.toFixed(1)}% ${s.avgChg !== 0 ? '(' + (s.avgChg >= 0 ? '+' : '') + s.avgChg.toFixed(2) + '%)' : ''}</span>`
                ).join('');
                tags.innerHTML = top10WeightTag + (sectorHtml || '');
            }

            // --- è®¡ç®—æ—¥æ¶¨è·Œå¹…ä¼°ç®—ï¼ˆæ ¸å¿ƒç®—æ³•ï¼‰â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
            // å…¬å¼: estimatedDayChg = Î£(w_i Ã— chg_i) + (1 - W_top) Ã— residual_rate
            //   w_i         = ç¬¬iä¸ªè‚¡ç¥¨å å‡€å€¼æ¯”ä¾‹ (%)ï¼Œå¦‚ 9.32 è¡¨ç¤º 9.32%
            //   chg_i       = ç¬¬iä¸ªè‚¡ç¥¨ä»Šæ—¥å®æ—¶æ¶¨è·Œå¹… (%)
            //   W_top       = TOP10 æ€»æƒé‡ä¹‹å’Œ (%)ï¼Œå¦‚ 62.86
            //   residual_rate = å‰©ä½™ä»“ä½çš„ä¼°ç®—æ¶¨è·Œç‡
            //                   å½“ fundgz gszzl å¯ç”¨æ—¶åæ¨: residual = (gszzl - top10_contribution) / (100 - W_top)
            //                   å½“ gszzl ä¸å¯ç”¨æˆ–å‰©ä½™æƒé‡ä¸º0æ—¶: residual = top10 åŠ æƒå¹³å‡æ¶¨è·Œç‡
            // æ³¨æ„: w_i æ˜¯ç™¾åˆ†æ¯”å€¼ (å¦‚9.32)ï¼Œæ‰€ä»¥ Î£(w_i Ã— chg_i) çš„å•ä½æ˜¯ %Ã—%ï¼Œéœ€è¦ /100 å½’ä¸€åŒ–
            {
                const status = getMarketStatus();
                if (status.canRealtimeUpdate || status.reason === 'åˆé—´ä¼‘å¸‚') {
                    // è®¡ç®— TOP10 åŠ æƒè´¡çŒ®
                    let top10Contribution = 0; // TOP10 å¯¹æ¶¨è·Œçš„è´¡çŒ® (%)
                    quotes.forEach(h => {
                        const w = h.ratio || 0;   // å å‡€å€¼æ¯”ä¾‹ (%)
                        const c = h.chg || 0;     // ä»Šæ—¥æ¶¨è·Œå¹… (%)
                        top10Contribution += (w / 100) * c; // w/100 æŠŠç™¾åˆ†æ¯”è½¬ä¸ºæ¯”ä¾‹ï¼Œä¹˜ä»¥chg(%)å¾—åˆ°è´¡çŒ®(%)
                    });

                    let residualWeight = 100 - top10Weight; // å‰©ä½™ä»“ä½æƒé‡ (%)
                    let residualRate = 0;                    // å‰©ä½™ä»“ä½ä¼°ç®—æ¶¨è·Œç‡ (%)

                    const fundgzGszzl = parseFloat(fund._fundgzDayGrowth); // fundgz æä¾›çš„æ•´ä½“ä¼°ç®—æ¶¨è·Œå¹… (%)
                    if (!isNaN(fundgzGszzl) && residualWeight > 0.01) {
                        // ç”¨ fundgz ä¼°ç®—åæ¨å‰©ä½™ä»“ä½æ¶¨è·Œç‡
                        // gszzl â‰ˆ top10_contribution + (residualWeight/100) Ã— residualRate
                        // âŸ¹ residualRate = (gszzl - top10_contribution) / (residualWeight/100)
                        residualRate = (fundgzGszzl - top10Contribution) / (residualWeight / 100);
                        // å®‰å…¨é™åˆ¶ï¼šå‰©ä½™ä¼°ç®—ä¸èƒ½è¶…è¿‡ TOP10 å‡å€¼çš„ 3å€ï¼Œé˜²æ­¢å¼‚å¸¸å€¼
                        const top10AvgRate = top10Weight > 0 ? top10Contribution / (top10Weight / 100) : 0;
                        if (Math.abs(residualRate) > Math.abs(top10AvgRate) * 3 + 5) {
                            residualRate = top10AvgRate; // å›é€€åˆ°TOP10å‡å€¼
                        }
                    } else if (top10Weight > 0) {
                        // gszzl ä¸å¯ç”¨æ—¶ï¼Œç”¨ TOP10 åŠ æƒå‡å€¼è¿‘ä¼¼å‰©ä½™éƒ¨åˆ†
                        residualRate = top10Contribution / (top10Weight / 100);
                    }

                    // æœ€ç»ˆä¼°ç®—æ¶¨è·Œå¹…ï¼šä¼˜å…ˆä½¿ç”¨ fundgz çš„æ•´ä½“ä¼°ç®—ï¼ˆå¸‚åœºé€šç”¨å£å¾„ï¼‰ï¼Œé¿å…å› é™å¹…/è¯¯å·®å¯¼è‡´æ•´ä½“è·‘å
                    const fallbackEst = top10Contribution + (residualWeight / 100) * residualRate;
                    const estDayChg = (!isNaN(fundgzGszzl)) ? fundgzGszzl : fallbackEst;

                    // å­˜å…¥ç¼“å­˜ä¾› updateMainDisplay ä½¿ç”¨
                    holdingsCache[fund.code] = {
                        top10Weight: top10Weight,
                        top10Contribution: top10Contribution,
                        residualWeight: residualWeight,
                        residualRate: residualRate,
                        estDayChg: estDayChg,
                        timestamp: Date.now()
                    };
                }
            }
        }

        async function updateHoldingsChgOnly(fund) {
            const tbody = document.getElementById('holdingsTableBody');
            if (!tbody) return;
            const list = Array.isArray(fund?._topHoldings) ? fund._topHoldings : [];
            if (list.length === 0) return;

            // æ‰¹é‡è¡Œæƒ…ï¼šä¸€æ¬¡è¯·æ±‚æ‹¿åˆ° TOP10 å…¨éƒ¨è‚¡ç¥¨æ¶¨è·Œå¹…ï¼Œé¿å… 1 ç§’å†…å¤šæ¬¡è¯·æ±‚
            const secids = list.map(h => getEastmoneySecId(h.code)).filter(Boolean).join(',');
            if (!secids) return;
            const url = `https://push2.eastmoney.com/api/qt/ulist.np/get?fltt=2&invt=2&secids=${secids}&fields=f12,f3&ut=fa5fd1943c7b386f172d6893dbfba10b&_=${Date.now()}`;

            let qjson;
            try {
                qjson = await runWithSourceStat('quote_ulist_np_get_jsonp', async () => await fetchJsonp(url, 'cb', 8000));
            } catch {
                qjson = await runWithSourceStat('quote_ulist_np_get_jsonp_callback', async () => await fetchJsonp(url, 'callback', 8000));
            }

            const diff = qjson?.data?.diff;
            const chgMap = {};
            if (Array.isArray(diff)) {
                diff.forEach(item => {
                    const code = (item?.f12 || '').toString();
                    const chg = Number(item?.f3);
                    if (code && Number.isFinite(chg)) chgMap[code] = chg;
                });
            }

            const quotes = list.map(h => ({
                code: h.code,
                chg: Number.isFinite(chgMap[h.code]) ? chgMap[h.code] : 0
            }));

            quotes.forEach(q => {
                const tr = tbody.querySelector(`tr[data-code="${q.code}"]`);
                if (!tr) return;
                const td = tr.querySelector('td.holding-chg');
                if (!td) return;
                td.className = `holding-chg ${q.chg >= 0 ? 'positive' : 'negative'}`;
                td.innerHTML = `<strong>${(q.chg > 0 ? '+' : '') + q.chg.toFixed(2) + '%'}</strong>`;
            });

            // åŒæ­¥æ›´æ–°â€œæ—¥æ¶¨è·Œå¹…â€çš„ä¼°ç®—ç¼“å­˜ï¼ˆè®©æŒä»“å®æ—¶æ¶¨è·Œä¸æ—¥æ¶¨è·Œå¹…è”åŠ¨ï¼‰

            const top10Weight = list.reduce((sum, h) => sum + (parseFloat(h.ratio) || 0), 0);
            let top10Contribution = 0;
            list.forEach(h => {
                const w = parseFloat(h.ratio) || 0;
                const c = Number.isFinite(chgMap[h.code]) ? chgMap[h.code] : 0;
                top10Contribution += (w / 100) * c;
            });

            const residualWeight = 100 - top10Weight;
            let residualRate = 0;
            const fundgzGszzl = parseFloat(fund._fundgzDayGrowth);
            if (!isNaN(fundgzGszzl) && residualWeight > 0.01) {
                residualRate = (fundgzGszzl - top10Contribution) / (residualWeight / 100);
                const top10AvgRate = top10Weight > 0 ? top10Contribution / (top10Weight / 100) : 0;
                if (Math.abs(residualRate) > Math.abs(top10AvgRate) * 3 + 5) {
                    residualRate = top10AvgRate;
                }
            } else if (top10Weight > 0) {
                residualRate = top10Contribution / (top10Weight / 100);
            }

            const fallbackEst = top10Contribution + (residualWeight / 100) * residualRate;
            const estDayChg = (!isNaN(fundgzGszzl)) ? fundgzGszzl : fallbackEst;

            holdingsCache[fund.code] = {
                top10Weight,
                top10Contribution,
                residualWeight,
                residualRate,
                estDayChg,
                timestamp: Date.now()
            };
            if (Number.isFinite(estDayChg)) fund.dayGrowth = estDayChg;
        }

        function initChart() {
            const dom = document.getElementById('klineChart');
            chart = echarts.init(dom);
            chart.setOption({
                tooltip: { trigger: 'axis', axisPointer: { type: 'cross' }, backgroundColor: 'rgba(255,255,255,0.95)', padding: 12 },
                grid: { left: '3%', right: '4%', bottom: '20', top: '20', containLabel: true },
                xAxis: { type: 'category', boundaryGap: false, axisLine: { lineStyle: { color: '#e5e5e5' } }, axisLabel: { color: '#737373' } },
                yAxis: { type: 'value', scale: true, splitLine: { lineStyle: { color: '#f5f5f5' } }, axisLabel: { color: '#737373' } },
                series: [{ name: 'å‡€å€¼', type: 'line', smooth: true, symbol: 'none', lineStyle: { width: 3, color: '#3b82f6' }, areaStyle: { color: new echarts.graphic.LinearGradient(0,0,0,1,[{offset:0,color:'rgba(59,130,246,0.3)'},{offset:1,color:'rgba(59,130,246,0.05)'}]) } }]
            });
            window.addEventListener('resize', () => chart.resize());
        }

        function changeTimeRange(range) {
            currentTimeRange = range;
            document.querySelectorAll('.time-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            if (range === 'realtime') {
                updateRealtimeChart();
                startRealtimeUpdate();
                if (selectedFund) fetchHistoryData(selectedFund.code, false);
            }
            else {
                stopRealtimeUpdate();
                if (!selectedFund) return;
                if (historyCache[selectedFund.code]) { renderHistoryChart(selectedFund.code); }
                else { fetchHistoryData(selectedFund.code, true); }
            }
        }

        function getRealtimeChartData(fund) {
            const labels = [];
            for (let m=570; m<=690; m++) labels.push(`${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`);
            for (let m=780; m<=900; m++) labels.push(`${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`);
            const history = getRealtimeSeriesForChart(fund);
            let end = getEffectiveRealtimeEndIndex(history);
            if (end < 0) end = history.length - 1;
            const xData = labels.slice(0, end + 1);
            const yData = history.slice(0, end + 1);
            return { labels, history, end, xData, yData };
        }

        function updateRealtimeChart() {
            if (!selectedFund) return;
            document.getElementById('chartTypeLabel').innerHTML = `å®æ—¶ä¼°å€¼èµ°åŠ¿`;
            const { xData, yData } = getRealtimeChartData(selectedFund);

            const baseNav = parseFloat(selectedFund.currentNav);
            chart.setOption({
                tooltip: {
                    trigger: 'axis',
                    formatter: (params) => {
                        const pNav = params?.[0];
                        const t = pNav?.axisValueLabel || '';
                        const nav = Number(pNav?.data);
                        const navText = Number.isFinite(nav) ? nav.toFixed(4) : '--';

                        let pct = NaN;
                        if (Number.isFinite(baseNav) && baseNav !== 0 && Number.isFinite(nav)) {
                            pct = ((nav - baseNav) / baseNav) * 100;
                        }
                        const pctText = Number.isFinite(pct) ? ((pct >= 0 ? '+' : '') + pct.toFixed(2) + '%') : '--';
                        const pctColor = Number.isFinite(pct) ? (pct >= 0 ? '#ef4444' : '#10b981') : '#737373';
                        return `${t}<br/>å‡€å€¼ï¼š${navText}<br/>æ¶¨è·Œå¹…ï¼š<span style="color:${pctColor};font-weight:700;">${pctText}</span>`;
                    }
                },
                xAxis: {
                    data: xData,
                    axisTick: { show: false },
                    minorTick: { show: false },
                    axisLabel: {
                        color: '#737373',
                        interval: 0,
                        formatter: (value) => {
                            if (value === '09:30') return '09:30';
                            if (value === '11:30') return '11:30/13:00';
                            if (value === '15:00') return '15:00';
                            return '';
                        }
                    }
                },
                series: [{ name: 'å‡€å€¼', data: yData }]
            });
        }

        // æ ¹æ®æ—¶é—´èŒƒå›´è®¡ç®—æˆªæ–­æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
        function getCutoffTimestamp(range) {
            const t = getShanghaiTimeParts();
            const today = new Date(Date.UTC(t.year, t.month - 1, t.day)); // ä¸Šæµ·"ä»Šå¤©"00:00 UTC
            let cutoff;
            switch (range) {
                case '5d':  cutoff = new Date(today); cutoff.setUTCDate(cutoff.getUTCDate() - 7); break;
                case '1m':  cutoff = new Date(today); cutoff.setUTCMonth(cutoff.getUTCMonth() - 1); break;
                case '3m':  cutoff = new Date(today); cutoff.setUTCMonth(cutoff.getUTCMonth() - 3); break;
                case '1y':  cutoff = new Date(today); cutoff.setUTCFullYear(cutoff.getUTCFullYear() - 1); break;
                case 'all': return 0; // æˆç«‹æ¥ä¸æˆªæ–­
                default:    cutoff = new Date(today); cutoff.setUTCDate(cutoff.getUTCDate() - 7); break;
            }
            return cutoff.getTime();
        }

        // å°†æ—¶é—´æˆ³è½¬ä¸º YYYY-MM-DDï¼ˆä¸Šæµ·æ—¶åŒº +8ï¼‰
        function tsToDateStr(ts) {
            const d = new Date(ts + 8 * 3600000); // åŠ 8å°æ—¶åæŒ‰UTCè¯»
            const y = d.getUTCFullYear();
            const m = String(d.getUTCMonth() + 1).padStart(2, '0');
            const dd = String(d.getUTCDate()).padStart(2, '0');
            return `${y}-${m}-${dd}`;
        }

        // ä»ç¼“å­˜æ•°æ®æ¸²æŸ“å›¾è¡¨ + å†å²è¡¨æ ¼ï¼ˆä¸å‘ç½‘ç»œè¯·æ±‚ï¼‰
        function renderHistoryChart(code) {
            const all = historyCache[code];
            if (!all || all.length === 0) return;

            const cutoff = getCutoffTimestamp(currentTimeRange);
            const data = all.filter(p => p.x >= cutoff); // æŒ‰æ—¶é—´æˆ³æˆªæ–­

            const labels = data.map(p => tsToDateStr(p.x));
            const values = data.map(p => p.y);

            const rangeLabel = { '5d':'1å‘¨', '1m':'1æœˆ', '3m':'3æœˆ', '1y':'1å¹´', 'all':'æˆç«‹æ¥' };
            document.getElementById('chartTypeLabel').innerHTML = `${rangeLabel[currentTimeRange] || ''}å‡€å€¼èµ°åŠ¿`;

            chart.setOption({
                xAxis: {
                    data: labels,
                    axisTick: { show: true },
                    minorTick: { show: false },
                    axisLabel: {
                        color: '#737373',
                        interval: 'auto',
                        formatter: null
                    }
                },
                series: [{ name: 'å‡€å€¼', data: values }]
            });
        }

        function resetHistoryTable(code) {
            historyTableState.code = code;
            historyTableState.rendered = 0;
            const tbody = document.getElementById('historyTableBody');
            if (tbody) tbody.innerHTML = '';
            appendHistoryTableRows();
        }

        function appendHistoryTableRows() {
            const code = historyTableState.code;
            const all = code ? historyCache[code] : null;
            const tbody = document.getElementById('historyTableBody');
            if (!tbody) return;
            if (!all || all.length === 0) {
                if (historyTableState.rendered === 0) {
                    tbody.innerHTML = `<tr><td colspan="4" style="text-align: center; color: var(--gray-500); padding: 40px;">æš‚æ— æ•°æ®</td></tr>`;
                }
                return;
            }

            const start = historyTableState.rendered;
            const end = Math.min(start + historyTableState.pageSize, all.length);
            if (start >= end) return;

            const rows = [];
            for (let k = start; k < end; k++) {
                const i = all.length - 1 - k;
                if (i < 0) break;
                const date = tsToDateStr(all[i].x);
                const val = all[i].y;
                const pct = i > 0 ? (((all[i].y - all[i - 1].y) / all[i - 1].y) * 100) : 0;
                rows.push(`<tr><td>${date}</td><td>${val.toFixed(4)}</td><td>--</td><td class="${pct>=0?'positive':'negative'}">${pct ? (pct >= 0 ? '+' : '') + pct.toFixed(2) + '%' : '--'}</td></tr>`);
            }

            if (historyTableState.rendered === 0) tbody.innerHTML = '';
            tbody.insertAdjacentHTML('beforeend', rows.join(''));
            historyTableState.rendered = end;
        }

        // æ‹‰å– pingzhongdata å…¨å†å²å¹¶ç¼“å­˜ï¼Œç„¶åæ¸²æŸ“
        async function fetchHistoryData(code, renderChart = true) {
            if (historyCache[code]) {
                if (renderChart) renderHistoryChart(code);
                resetHistoryTable(code);
                return;
            }

            try {
                console.log(`ğŸ”„ [å†å²-pingzhongdata] æ‹‰å– ${code}...`);
                await loadScript(`https://fund.eastmoney.com/pingzhongdata/${code}.js?rt=${Date.now()}`, 12000);
                const raw = window.Data_netWorthTrend;
                if (!Array.isArray(raw) || raw.length === 0) throw new Error('Data_netWorthTrend ä¸ºç©º');

                // ç¼“å­˜å…¨éƒ¨æ•°æ®ï¼ˆæ¯æ¡ {x: æ—¶é—´æˆ³, y: å‡€å€¼}ï¼‰
                historyCache[code] = raw.map(item => ({ x: item.x, y: item.y }));
                console.log(`âœ… [å†å²-pingzhongdata] ${code} å…± ${raw.length} æ¡ï¼Œå·²ç¼“å­˜`);

                // ç”¨æœ€æ–°ä¸€æ¡åŒæ­¥å‡€å€¼
                if (selectedFund && selectedFund.code === code) {
                    const latest = raw[raw.length - 1];
                    const prev   = raw.length >= 2 ? raw[raw.length - 2] : null;
                    const jzrq   = tsToDateStr(latest.x);
                    if (jzrq > (selectedFund.navDate || '')) {
                        selectedFund.navDate  = jzrq;
                        selectedFund.currentNav = latest.y;
                        saveFunds();
                        updateMainDisplay(selectedFund);
                    }
                }

                if (renderChart) renderHistoryChart(code);
                resetHistoryTable(code);
            } catch(e) {
                console.error('ğŸ’¥ å†å²æ•°æ®åŠ è½½å¤±è´¥:', e);
                document.getElementById('historyTableBody').innerHTML = `<tr><td colspan="4" style="text-align:center;color:var(--gray-500);padding:40px;">æ•°æ®åŠ è½½å¤±è´¥</td></tr>`;
            }
        }

        document.getElementById('historyScroll')?.addEventListener('scroll', (e) => {
            const el = e.target;
            if (!el) return;
            if (el.scrollTop + el.clientHeight >= el.scrollHeight - 20) {
                appendHistoryTableRows();
            }
        });

        function startRealtimeUpdate() { startUnifiedRefreshLoop(); }
        function stopRealtimeUpdate() { /* unified loop handles stop */ }
        function startAutoUpdate() { startUnifiedRefreshLoop(); }

        function startUnifiedRefreshLoop() {
            if (refreshInterval) return;
            refreshInterval = setInterval(() => {
                refreshLock = refreshLock.then(async () => {
                    const status = getMarketStatus();
                    if (!status.canRealtimeUpdate) return;
                    const now = Date.now();

                    // å…¨å±€é™æµï¼šæ¯ç§’æœ€å¤šä¸€æ¬¡â€œç½‘ç»œä»»åŠ¡â€ï¼Œç”¨è½®è¯¢è°ƒåº¦ä¿è¯å„æ¨¡å—éƒ½èƒ½æ›´æ–°
                    // tick%4:
                    //   0/1: è½®è¯¢åˆ·æ–°ä¸€åªåŸºé‡‘ä¼°å€¼ï¼ˆé¿å…å¤šåŸºé‡‘åŒç§’å¤šè¯·æ±‚ï¼‰
                    //   2:   åˆ·æ–°é€‰ä¸­åŸºé‡‘æŒä»“æ¶¨è·Œï¼ˆæ‰¹é‡æ¥å£ä¸€æ¬¡è¯·æ±‚ï¼‰
                    //   3:   åˆ·æ–°æŒ‡æ•°
                    refreshTick = (refreshTick + 1) % 4;

                    if ((refreshTick === 0 || refreshTick === 1) && funds.length > 0 && now - lastFundRefreshAt >= 2900) {
                        lastFundRefreshAt = now;
                        fundRefreshCursor = fundRefreshCursor % funds.length;
                        const f = funds[fundRefreshCursor];
                        fundRefreshCursor++;
                        await fetchFundData(f, { suppressRender: true });
                        renderFundList();
                        if (selectedFund?.code === f.code) {
                            updateMainDisplay(selectedFund);
                            if (currentTimeRange === 'realtime') updateRealtimeChart();
                        }
                        return;
                    }

                    if (refreshTick === 2 && selectedFund) {
                        // äº¤æ˜“æ—¶æ¯ç§’ä»…æ›´æ–°â€œæŒä»“æ¶¨è·Œå¹…â€ï¼Œä¸é‡ç»˜æŒä»“/æ¿å—ï¼ˆæ‰¹é‡ä¸€æ¬¡è¯·æ±‚ï¼‰
                        await loadHoldingsAndSectors(selectedFund, { updateOnly: true });
                        updateDayGrowthDisplay(selectedFund);
                        return;
                    }

                    if (refreshTick === 3 && now - lastIndicesRefreshAt >= 2900) {
                        lastIndicesRefreshAt = now;
                        await fetchMarketIndices();
                        return;
                    }

                    // ç»“æ„æ€§æŒä»“/æ¿å—ï¼šç»´æŒä½é¢‘ï¼ˆä¸å ç”¨æ¯ç§’é¢„ç®—ï¼Œåªæœ‰è½®åˆ°ä¸”è¶…æ—¶æ‰åˆ·æ–°ï¼‰
                    if (selectedFund && now - lastHoldingsRefreshAt >= 30000) {
                        lastHoldingsRefreshAt = now;
                        await loadHoldingsAndSectors(selectedFund, { silent: true });
                        return;
                    }
                }).catch(err => console.warn('unified refresh loop error:', err));
            }, 3000);
        }

        function stopUnifiedRefreshLoop() {
            if (!refreshInterval) return;
            clearInterval(refreshInterval);
            refreshInterval = null;
        }
        function showToast(msg, type='success') { const t = document.createElement('div'); t.className=`toast ${type}`; t.innerText=msg; document.body.appendChild(t); setTimeout(()=>t.remove(), 3000); }

        let _suggestTimer = null;
        let _suggestItems = [];
        let _suggestActive = -1;

        async function fetchFundSuggest(keyword) {
            const key = (keyword || '').trim();
            if (!key) return [];
            const url = `https://fundsuggest.eastmoney.com/FundSearch/api/FundSearchAPI.ashx?m=1&key=${encodeURIComponent(key)}`;
            const json = await runWithSourceStat('fund_suggest_jsonp', async () => await fetchJsonp(url, 'callback', 8000));
            const arr = json?.Datas || json?.data || [];
            if (!Array.isArray(arr)) return [];
            return arr.map(x => {
                const code = (x.CODE || x.FCODE || x.code || '').toString();
                const name = (x.NAME || x.SHORTNAME || x.name || '').toString();
                const type = (x.JJType || x.type || '').toString();
                return { code, name, type };
            }).filter(x => /^\d{6}$/.test(x.code) && x.name);
        }

        function renderFundSuggest(items) {
            const box = document.getElementById('fundSuggest');
            if (!box) return;
            _suggestItems = Array.isArray(items) ? items.slice(0, 12) : [];
            _suggestActive = -1;
            if (_suggestItems.length === 0) {
                box.style.display = 'none';
                box.innerHTML = '';
                return;
            }
            box.style.display = 'block';
            box.innerHTML = _suggestItems.map((it, idx) => {
                const meta = it.type ? it.type : 'åŸºé‡‘';
                return `<div class="fund-suggest-item" data-idx="${idx}" onclick="selectSuggestItem(${idx})"><div class="fund-suggest-left"><div class="fund-suggest-name">${it.name}</div><div class="fund-suggest-meta">${meta}</div></div><div class="fund-suggest-code">${it.code}</div></div>`;
            }).join('');
        }

        function selectSuggestItem(idx) {
            const it = _suggestItems[idx];
            if (!it) return;
            const input = document.getElementById('fundCode');
            if (input) input.value = it.code;
            const box = document.getElementById('fundSuggest');
            if (box) { box.style.display = 'none'; box.innerHTML = ''; }
            _suggestItems = [];
            _suggestActive = -1;
            input?.focus();
        }

        function moveSuggestActive(delta) {
            const box = document.getElementById('fundSuggest');
            if (!box || box.style.display === 'none') return;
            const items = box.querySelectorAll('.fund-suggest-item');
            if (!items || items.length === 0) return;
            _suggestActive += delta;
            if (_suggestActive < 0) _suggestActive = items.length - 1;
            if (_suggestActive >= items.length) _suggestActive = 0;
            items.forEach((el, i) => el.classList.toggle('active', i === _suggestActive));
            const activeEl = items[_suggestActive];
            if (activeEl) activeEl.scrollIntoView({ block: 'nearest' });
        }

        document.getElementById('fundCode')?.addEventListener('input', (e) => {
            const v = (e.target.value || '').trim();
            clearTimeout(_suggestTimer);
            if (v.length < 2 || /^\d{6}$/.test(v)) { renderFundSuggest([]); return; }
            _suggestTimer = setTimeout(async () => {
                try {
                    const items = await fetchFundSuggest(v);
                    renderFundSuggest(items);
                } catch {
                    renderFundSuggest([]);
                }
            }, 220);
        });

        document.getElementById('fundCode')?.addEventListener('keydown', (e) => {
            const box = document.getElementById('fundSuggest');
            const visible = box && box.style.display !== 'none';
            if (!visible) {
                if (e.key === 'Enter') { addFund(); e.preventDefault(); }
                return;
            }
            if (e.key === 'ArrowDown') { moveSuggestActive(1); e.preventDefault(); return; }
            if (e.key === 'ArrowUp') { moveSuggestActive(-1); e.preventDefault(); return; }
            if (e.key === 'Enter') {
                if (_suggestActive >= 0) { selectSuggestItem(_suggestActive); }
                else if (_suggestItems.length > 0) { selectSuggestItem(0); }
                e.preventDefault();
                return;
            }
            if (e.key === 'Escape') { renderFundSuggest([]); return; }
        });

        document.addEventListener('click', (e) => {
            const box = document.getElementById('fundSuggest');
            const input = document.getElementById('fundCode');
            if (!box || !input) return;
            if (e.target === input || box.contains(e.target)) return;
            renderFundSuggest([]);
        });
    </script>
</body>
</html>
